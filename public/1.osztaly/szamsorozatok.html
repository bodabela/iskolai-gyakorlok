<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. Oszt√°ly - Sz√°msorozatok Szab√°lyfelismer√©ssel</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start; /* Igaz√≠t√°s a t√∂bb soros csoportokhoz */
            gap: 10px 15px;
            width:100%;
        }
        .settings-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
        }

        .control-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.95em;
            transition: color 0.5s ease;
        }

        .theme-button, .range-button, .mode-button { /* mode-button hozz√°adva */
            padding: 8px 12px;
            border: 1px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }
        .theme-button:hover, .range-button:hover, .mode-button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        .theme-button.active, .range-button.active, .mode-button.active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px var(--theme-button-active-border-color, #000);
            transform: translateY(1px);
        }
        
        .range-selector, .mode-selector { /* mode-selector hozz√°adva */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }


        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
            text-align: center;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        h1, h2 {
            text-align: center;
            transition: color 0.5s ease;
        }
        h1 {
            font-size: clamp(1.8em, 5vw, 2.2em);
            margin-bottom: 15px;
        }
        h2 {
            font-size: clamp(1.3em, 4vw, 1.6em);
            margin-bottom: 25px;
        }
        .task {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            transition: background-color 0.5s ease, border-color 0.5s ease;
            position: relative;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .task-header h3 {
            margin-top: 0;
            margin-bottom: 0;
            font-size: clamp(1.1em, 3.5vw, 1.3em);
            transition: color 0.5s ease;
        }
        .new-task-button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .task p.instructions {
            line-height: 1.6;
            font-size: clamp(1em, 3vw, 1.1em);
            margin-bottom: 15px;
            transition: color 0.5s ease;
        }

        .sequence-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center; 
            gap: 5px;
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            min-height: 60px;
            transition: background-color 0.3s ease;
            overflow-x: auto;
            width: 100%;
            box-sizing: border-box;
        }
        .sequence-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.3em, 4.5vw, 1.6em);
            font-weight: bold;
            transition: color 0.5s ease, min-width 0.3s ease, height 0.3s ease, margin 0.3s ease;
            min-width: 40px;
            height: 40px;
            margin: 0 3px;
        }
        .sequence-item .number-display {
            padding: 5px 8px;
            border-radius: 6px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            min-width: 35px;
        }
        .sequence-item input[type="number"] {
            width: 45px;
            height: 40px;
            padding: 5px;
            font-size: 0.9em;
            text-align: center;
            border-radius: 6px;
            border: 2px solid transparent;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .operator-input-item {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 0 1px; 
        }
        .rule-operator-input {
            width: 35px;
            height: 30px;
            font-size: 0.75em; 
            text-align: center;
            border: 1px solid #cccccc; 
            border-radius: 4px;
            box-sizing: border-box;
            padding: 2px;
            background-color: #f8f8f8; 
            color: #444444; 
        }


        .rule-options-container {
            margin-top: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        .rule-option-button {
            padding: 12px 15px;
            font-size: clamp(0.9em, 2.8vw, 1.05em);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s, transform 0.2s;
            border: 2px solid;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .rule-option-button:hover {
            transform: translateY(-2px);
            opacity: 0.9;
        }
        .rule-option-button.selected { }


        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        button.task-button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(1em, 3vw, 1.1em);
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button.task-button:hover {
            transform: translateY(-2px);
        }
        button.task-button:active {
            transform: translateY(0px);
        }
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            padding: 10px;
            border-radius: 6px;
            font-size: clamp(0.9em, 2.8vw, 1.05em);
            transition: color 0.5s ease, background-color 0.5s ease, border-color 0.5s ease;
            min-height: 1.5em;
            line-height: 1.4;
        }
        
        #step2_select_rule { display: none; }

        input.correct-input {
            border-color: var(--feedback-correct-border-color, green) !important;
            box-shadow: 0 0 0 2px var(--feedback-correct-border-color, green);
        }
        input.incorrect-input {
            border-color: var(--feedback-incorrect-border-color, red) !important;
            box-shadow: 0 0 0 2px var(--feedback-incorrect-border-color, red);
        }

        /* Alap√©rtelmezett t√©ma st√≠lusok */
        .theme-button, .range-button, .mode-button { background-color: #e0e0e0; color: #333; border: 1px solid #ccc; }
        button.task-button { background-color: #007bff; color: white; }
        .container { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .task { background-color: #f9fafb; border: 1px dashed #d1d5db; }
        .feedback.correct { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .feedback.incorrect { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        h1, h2 { color: #007bff; }
        .sequence-container { background-color: #f0f8ff; }
        .sequence-item { color: #0056b3; }
        .sequence-item .number-display { background-color: #bee3f8; color: #004085; }
        .sequence-item input[type="number"] { border-color: #90cdf4; background-color: #ffffff;}
        .rule-option-button { background-color: #e9ecef; color: #495057; border-color: #ced4da;}
        .rule-option-button.selected { background-color: #007bff; color: white; border-color: #0056b3;}


        /* --- THEME DEFINITIONS --- */
        body.theme-candy { background-color: #fff0f5; color: #8a2be2; --theme-button-active-border-color: #da70d6;
             --feedback-correct-border-color: #90ee90; --feedback-incorrect-border-color: #ffb6c1;
        }
        body.theme-candy .control-label { color: #c71585; }
        body.theme-candy .theme-button.active, body.theme-candy .range-button.active, body.theme-candy .mode-button.active { background-color: #ffb6c1; color: #7c3c60; }
        body.theme-candy .container { background-color: #ffe4e1; border-color: #ffc0cb; }
        body.theme-candy h1, body.theme-candy h2 { color: #da70d6; }
        body.theme-candy .task { background-color: #fffafa; border-color: #ffb6c1; }
        body.theme-candy .task-header h3 { color: #ff69b4; }
        body.theme-candy .task p.instructions { color: #8a2be2; }
        body.theme-candy button.task-button { background-color: #ff69b4; }
        body.theme-candy .feedback.correct { color: #228b22; background-color: #f0fff0; border-color: #90ee90; }
        body.theme-candy .feedback.incorrect { color: #dc143c; background-color: #fff0f5; border-color: #ffb6c1; }
        body.theme-candy .sequence-container { background-color: #fff0f5; }
        body.theme-candy .sequence-item { color: #c71585; }
        body.theme-candy .sequence-item .number-display { background-color: #ffb6c1; color: #a52a2a; }
        body.theme-candy .sequence-item input[type="number"] { border-color: #ffc0cb; background-color: #fff5f8;}
        body.theme-candy .rule-operator-input { border-color: #ffc0cb; background-color: #fffafa; color: #c71585; }
        body.theme-candy .rule-option-button { background-color: #ffebf0; color: #c71585; border-color: #ffb6c1;}
        body.theme-candy .rule-option-button.selected { background-color: #ff69b4; color: white; border-color: #ff1493;}


        body.theme-space { background-color: #0f172a; color: #e2e8f0; --theme-button-active-border-color: #60a5fa;
            --feedback-correct-border-color: #22c55e; --feedback-incorrect-border-color: #ef4444;
        }
        body.theme-space .control-label { color: #93c5fd; }
        body.theme-space .theme-button.active, body.theme-space .range-button.active, body.theme-space .mode-button.active { background-color: #1e3a8a; color: #93c5fd; }
        body.theme-space .container { background-color: #1e293b; border-color: #334155; }
        body.theme-space h1, body.theme-space h2 { color: #60a5fa; }
        body.theme-space .task { background-color: #334155; border-color: #475569; }
        body.theme-space .task-header h3 { color: #93c5fd; }
        body.theme-space .task p.instructions { color: #cbd5e1; }
        body.theme-space button.task-button { background-color: #2563eb; }
        body.theme-space .feedback.correct { color: #4ade80; background-color: #162d22; border-color: #22c55e; }
        body.theme-space .feedback.incorrect { color: #f87171; background-color: #3f1a1a; border-color: #ef4444; }
        body.theme-space .sequence-container { background-color: #111827; }
        body.theme-space .sequence-item { color: #93c5fd; }
        body.theme-space .sequence-item .number-display { background-color: #374151; color: #e5e7eb; }
        body.theme-space .sequence-item input[type="number"] { border-color: #4b5563; background-color: #1f2937; color: #e5e7eb; }
        body.theme-space .rule-operator-input { border-color: #4b5563; background-color: #2d3748; color: #93c5fd; }
        body.theme-space .rule-option-button { background-color: #334155; color: #9ca3af; border-color: #4b5563;}
        body.theme-space .rule-option-button.selected { background-color: #2563eb; color: white; border-color: #1d4ed8;}


        body.theme-jungle { background-color: #f0fff0; color: #1b5e20; --theme-button-active-border-color: #558b2f;
            --feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;
        }
        body.theme-jungle .control-label { color: #558b2f; }
        body.theme-jungle .theme-button.active, body.theme-jungle .range-button.active, body.theme-jungle .mode-button.active { background-color: #689f38; color: #dcedc8; }
        body.theme-jungle .container { background-color: #e8f5e9; border-color: #a5d6a7; }
        body.theme-jungle h1, body.theme-jungle h2 { color: #388e3c; }
        body.theme-jungle .task { background-color: #dcedc8; border-color: #81c784; }
        body.theme-jungle .task-header h3 { color: #558b2f; }
        body.theme-jungle .task p.instructions { color: #2e7d32; }
        body.theme-jungle button.task-button { background-color: #7cb342; }
        body.theme-jungle .feedback.correct { color: #388e3c; background-color: #e8f5e9; border-color: #a5d6a7; }
        body.theme-jungle .feedback.incorrect { color: #d32f2f; background-color: #ffebee; border-color: #ef9a9a; }
        body.theme-jungle .sequence-container { background-color: #dcedc8; }
        body.theme-jungle .sequence-item { color: #2e7d32; }
        body.theme-jungle .sequence-item .number-display { background-color: #a5d6a7; color: #1b5e20; }
        body.theme-jungle .sequence-item input[type="number"] { border-color: #81c784; background-color: #f1f8e9; }
        body.theme-jungle .rule-operator-input { border-color: #a5d6a7; background-color: #e8f5e9; color: #388e3c; }
        body.theme-jungle .rule-option-button { background-color: #c8e6c9; color: #388e3c; border-color: #a5d6a7;}
        body.theme-jungle .rule-option-button.selected { background-color: #7cb342; color: white; border-color: #689f38;}

        body.theme-magicforest { --theme-button-active-border-color: #8a2be2; --feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}
        body.theme-tech { --theme-button-active-border-color: #00acc1;--feedback-correct-border-color: #4caf50; --feedback-incorrect-border-color: #f44336;}
        body.theme-ocean { --theme-button-active-border-color: #20b2aa;--feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}
        body.theme-sport { --theme-button-active-border-color: #d32f2f;--feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}
        body.theme-flowergarden { --theme-button-active-border-color: #ff6347;--feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}
        body.theme-adventure { --theme-button-active-border-color: #bf360c;--feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}
        body.theme-sky { --theme-button-active-border-color: #1e90ff;--feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;}

        body.theme-magicforest .sequence-item { color: #6a0dad; } body.theme-magicforest .sequence-item .number-display { background-color: #dda0dd; color: #483d8b; } body.theme-magicforest .sequence-item input {border-color: #ba55d3; background-color: #f8f0ff;} body.theme-magicforest .rule-operator-input {border-color: #dda0dd; background-color: #f0e6ff; color: #6a0dad;} body.theme-magicforest .rule-option-button {background-color: #e6e6fa; color:#6a0dad; border-color: #dda0dd;} body.theme-magicforest .rule-option-button.selected {background-color: #9370db; color:white; border-color:#8a2be2;}
        body.theme-tech .sequence-item { color: #80d8ff; } body.theme-tech .sequence-item .number-display { background-color: #455a64; color: #e0f7fa; } body.theme-tech .sequence-item input {border-color: #546e7a; background-color: #37474f; color: #e0f7fa;} body.theme-tech .rule-operator-input {border-color: #78909c; background-color: #37474f; color: #b0bec5;} body.theme-tech .rule-option-button {background-color: #455a64; color:#b0bec5; border-color: #78909c;} body.theme-tech .rule-option-button.selected {background-color: #0097a7; color:white; border-color:#00838f;}
        body.theme-ocean .sequence-item { color: #00695c; } body.theme-ocean .sequence-item .number-display { background-color: #80deea; color: #004d40; } body.theme-ocean .sequence-item input {border-color: #4dd0e1; background-color: #e0f2f1;} body.theme-ocean .rule-operator-input {border-color: #80deea; background-color: #e0f7fa; color: #00695c;} body.theme-ocean .rule-option-button {background-color: #b2ebf2; color:#00796b; border-color: #80deea;} body.theme-ocean .rule-option-button.selected {background-color: #26a69a; color:white; border-color:#00897b;}
        body.theme-sport .sequence-item { color: #0d47a1; } body.theme-sport .sequence-item .number-display { background-color: #90caf9; color: #023047; } body.theme-sport .sequence-item input {border-color: #64b5f6; background-color: #e3f2fd;} body.theme-sport .rule-operator-input {border-color: #90caf9; background-color: #e3f2fd; color: #0d47a1;} body.theme-sport .rule-option-button {background-color: #bbdefb; color:#0d47a1; border-color: #90caf9;} body.theme-sport .rule-option-button.selected {background-color: #2196f3; color:white; border-color:#1976d2;}
        body.theme-flowergarden .sequence-item { color: #8b4513; } body.theme-flowergarden .sequence-item .number-display { background-color: #ffdab9; color: #5d4037; } body.theme-flowergarden .sequence-item input {border-color: #ffe4b5; background-color: #fffaf0;} body.theme-flowergarden .rule-operator-input {border-color: #ffdab9; background-color: #fff8f0; color: #8b4513;} body.theme-flowergarden .rule-option-button {background-color: #fff5ee; color:#d2691e; border-color: #ffdab9;} body.theme-flowergarden .rule-option-button.selected {background-color: #ffa07a; color:white; border-color:#ff7f50;}
        body.theme-adventure .sequence-item { color: #4e342e; } body.theme-adventure .sequence-item .number-display { background-color: #a1887f; color: #f5f5dc; } body.theme-adventure .sequence-item input {border-color: #8d6e63; background-color: #efebe9;} body.theme-adventure .rule-operator-input {border-color: #a1887f; background-color: #d7ccc8; color: #4e342e;} body.theme-adventure .rule-option-button {background-color: #d7ccc8; color:#5d4037; border-color: #a1887f;} body.theme-adventure .rule-option-button.selected {background-color: #795548; color:white; border-color:#5d4037;}
        body.theme-sky .sequence-item { color: #1e90ff; } body.theme-sky .sequence-item .number-display { background-color: #b0e0e6; color: #005a9c; } body.theme-sky .sequence-item input {border-color: #add8e6; background-color: #f0f8ff;} body.theme-sky .rule-operator-input {border-color: #b0e0e6; background-color: #e6faff; color: #1e90ff;} body.theme-sky .rule-option-button {background-color: #e6f7ff; color:#1e90ff; border-color: #b0e0e6;} body.theme-sky .rule-option-button.selected {background-color: #87cefa; color:white; border-color:#6495ed;}

    </style>
</head>
<body class="theme-candy">
    <div class="controls-container">
         <div class="settings-row">
            <div class="settings-group">
                <p class="control-label">T√©ma v√°laszt√≥:</p>
                <div id="themeSelector" class="theme-selector">
                    <button class="theme-button" data-theme="theme-candy">Cukorka</button>
                    <button class="theme-button" data-theme="theme-magicforest">Var√°zserd≈ë</button>
                    <button class="theme-button" data-theme="theme-ocean">√ìce√°n</button>
                    <button class="theme-button" data-theme="theme-flowergarden">Vir√°goskert</button>
                    <button class="theme-button" data-theme="theme-sky">√âgbolt</button>
                    <button class="theme-button" data-theme="theme-space">≈∞r</button>
                    <button class="theme-button" data-theme="theme-jungle">≈êserd≈ë</button>
                    <button class="theme-button" data-theme="theme-tech">Techno</button>
                    <button class="theme-button" data-theme="theme-sport">Sport</button>
                    <button class="theme-button" data-theme="theme-adventure">Kaland</button>
                </div>
            </div>
            <div class="settings-group">
                <p class="control-label">Sz√°mk√∂r:</p>
                <div id="rangeSelector" class="range-selector">
                    <button class="range-button" data-range="5">5-√∂s</button>
                    <button class="range-button active" data-range="10">10-es</button>
                    <button class="range-button" data-range="20">20-as</button>
                </div>
            </div>
            <div class="settings-group">
                <p class="control-label">Feladat M√≥dja:</p>
                <div id="modeSelector" class="mode-selector">
                    <button class="mode-button active" data-mode="memory">Eml√©kezetb≈ël</button>
                    <button class="mode-button" data-mode="reminder">Eml√©keztet≈ëvel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Sz√°msorozatok</h1>
        <h2>1. Oszt√°ly</h2>

        <div id="sequenceTask" class="task">
            <div class="task-header">
                <h3 id="taskTitle">Folytasd a sz√°msorozatot, majd tal√°ld ki a szab√°lyt!</h3>
                <button id="newTaskButton" class="task-button new-task-button">√öj feladat</button>
            </div>

            <div id="step1_fill_sequence">
                <p class="instructions" id="step1Instructions">√çrd be a hi√°nyz√≥ sz√°mokat a sorozatba!</p>
                <div id="sequenceDisplayArea" class="sequence-container">
                    </div>
                <button id="checkSequenceButton" class="task-button">Sorozat ellen≈ërz√©se</button>
                <p id="feedbackStep1" class="feedback"></p>
            </div>

            <div id="step2_select_rule" style="display: none;">
                <hr style="margin: 30px 0; border-top: 1px dashed var(--task-border, #ccc);">
                <p class="instructions">Melyik szab√°ly alapj√°n folytattad a sorozatot? V√°laszd ki a helyeset!</p>
                <div id="ruleOptionsContainer" class="rule-options-container">
                    </div>
                <button id="checkRuleButton" class="task-button">Szab√°ly ellen≈ërz√©se</button>
                <p id="feedbackStep2" class="feedback"></p>
            </div>
        </div>
    </div>

    <script>
        const bodyEl = document.body;
        const themeSelector = document.getElementById('themeSelector');
        const rangeSelector = document.getElementById('rangeSelector');
        const modeSelector = document.getElementById('modeSelector'); // √öJ
        const newTaskButton = document.getElementById('newTaskButton');
        
        const sequenceDisplayArea = document.getElementById('sequenceDisplayArea');
        const checkSequenceButton = document.getElementById('checkSequenceButton');
        const feedbackStep1 = document.getElementById('feedbackStep1');
        const step1Instructions = document.getElementById('step1Instructions'); // √öJ
        
        const step2Container = document.getElementById('step2_select_rule');
        const ruleOptionsContainer = document.getElementById('ruleOptionsContainer');
        const checkRuleButton = document.getElementById('checkRuleButton');
        const feedbackStep2 = document.getElementById('feedbackStep2');

        let currentSettings = {
            theme: 'theme-candy',
            numberRangeMax: 10,
            displayMode: 'memory' // √öJ: 'memory' vagy 'reminder'
        };

        let currentTask = {
            startNumber: 0,
            rule: [],
            sequence: [],
            shownElements: 3, 
            elementsToFill: 0,
            correctRuleString: "",
            ruleOptions: []
        };
        let userSequenceInputs = [];
        let selectedRuleOption = null;

        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function applyTheme(themeClass) {
            bodyEl.className = ''; 
            bodyEl.classList.add(themeClass); 
            currentSettings.theme = themeClass;
            themeSelector.querySelectorAll('.theme-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.theme === themeClass);
            });
            rangeSelector.querySelectorAll('.range-button').forEach(btn => { 
                btn.classList.toggle('active', parseInt(btn.dataset.range) === currentSettings.numberRangeMax);
            });
            modeSelector.querySelectorAll('.mode-button').forEach(btn => { // √öJ
                btn.classList.toggle('active', btn.dataset.mode === currentSettings.displayMode);
            });
        }

        themeSelector.addEventListener('click', (e) => { 
            if (e.target.classList.contains('theme-button')) { 
                applyTheme(e.target.dataset.theme); 
            } 
        });
        
        rangeSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('range-button')) {
                currentSettings.numberRangeMax = parseInt(e.target.dataset.range);
                // Az applyTheme friss√≠ti az active class-t, de ha csak ez v√°ltozik, explicit kell
                rangeSelector.querySelectorAll('.range-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                generateNewSequenceTask();
            }
        });

        // √öJ: M√≥dv√°laszt√≥ esem√©nykezel≈ë
        modeSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('mode-button')) {
                currentSettings.displayMode = e.target.dataset.mode;
                modeSelector.querySelectorAll('.mode-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                updateStep1Instructions(); // Instrukci√≥ friss√≠t√©se
                renderSequenceStep(); // Csak a megjelen√≠t√©st friss√≠tj√ºk, nem kell √∫j feladat
            }
        });

        function updateStep1Instructions() {
            if (currentSettings.displayMode === 'reminder') {
                step1Instructions.textContent = "√çrd be a hi√°nyz√≥ sz√°mokat a sorozatba! A sz√°mok k√∂z√© be√≠rhatod a szab√°lyt, amit gondolsz (pl. +2).";
            } else {
                step1Instructions.textContent = "√çrd be a hi√°nyz√≥ sz√°mokat a sorozatba!";
            }
        }
        
        function generateNewSequenceTask() {
            feedbackStep1.textContent = ''; feedbackStep1.className = 'feedback';
            feedbackStep2.textContent = ''; feedbackStep2.className = 'feedback';
            step2Container.style.display = 'none';
            checkSequenceButton.disabled = false;
            checkRuleButton.disabled = false; 
            selectedRuleOption = null;
            userSequenceInputs.forEach(input => input.disabled = false);
            userSequenceInputs = [];

            generateRuleAndSequence();
            generateRuleOptions();
            updateStep1Instructions(); // Instrukci√≥ friss√≠t√©se az √∫j feladathoz is
            renderSequenceStep();
            
            console.log("√öj feladat gener√°lva:", JSON.parse(JSON.stringify(currentTask)));
        }

        function generateRuleAndSequence() {
            let ruleLength = Math.random() < 0.6 ? 2 : 3;
            currentTask.shownElements = ruleLength + 1; 

            let rule = [];
            let tempSequence = [];
            let startNum;
            let validSequence = false;
            let attempts = 0;

            while(!validSequence && attempts < 200) {
                attempts++;
                rule = [];
                tempSequence = [];
                startNum = getRandomInt(0, Math.floor(currentSettings.numberRangeMax * 0.6)); 

                for (let i = 0; i < ruleLength; i++) {
                    let op = Math.random() < 0.5 ? '+' : '-';
                    let maxRuleVal = 1;
                    if (currentSettings.numberRangeMax === 5) maxRuleVal = 1;
                    else if (currentSettings.numberRangeMax === 10) maxRuleVal = 2;
                    else maxRuleVal = 3; 
                    let val = getRandomInt(1, maxRuleVal); 
                    rule.push({op, val});
                }

                tempSequence.push(startNum);
                let currentNum = startNum;
                const totalElementsInSequence = currentTask.shownElements + (rule.length * 2);

                validSequence = true; 
                for (let i = 0; i < totalElementsInSequence - 1; i++) {
                    const currentRuleStep = rule[i % rule.length];
                    if (currentRuleStep.op === '+') {
                        currentNum += currentRuleStep.val;
                    } else {
                        currentNum -= currentRuleStep.val;
                    }
                    if (currentNum < 0 || currentNum > currentSettings.numberRangeMax) {
                        validSequence = false;
                        break; 
                    }
                    tempSequence.push(currentNum);
                }
                if (validSequence && tempSequence.length !== totalElementsInSequence) {
                    validSequence = false; 
                }
            }

             if (!validSequence) { 
                console.warn("Fallback sequence generation!");
                ruleLength = 2; 
                currentTask.shownElements = ruleLength + 1;
                startNum = currentSettings.numberRangeMax === 5 ? 1 : (currentSettings.numberRangeMax === 10 ? 2: 4);
                rule = [{op: '+', val: 1}, {op: '-', val: 1}];
                if (currentSettings.numberRangeMax === 20) rule = [{op: '+', val: 2}, {op: '-', val: 1}];

                tempSequence = [startNum];
                let currentNumFallback = startNum;
                const totalElementsInSequenceFallback = currentTask.shownElements + (rule.length * 2);

                 for (let i = 0; i < totalElementsInSequenceFallback -1; i++) {
                    const currentRuleStep = rule[i % rule.length];
                    currentNumFallback = (currentRuleStep.op === '+') ? currentNumFallback + currentRuleStep.val : currentNumFallback - currentRuleStep.val;
                    if (currentNumFallback < 0) currentNumFallback = 0;
                    if (currentNumFallback > currentSettings.numberRangeMax) currentNumFallback = currentSettings.numberRangeMax;
                    tempSequence.push(currentNumFallback);
                }
            }

            currentTask.startNumber = startNum;
            currentTask.rule = rule;
            currentTask.sequence = tempSequence;
            currentTask.elementsToFill = rule.length * 2;
            currentTask.correctRuleString = rule.map(r => `${r.op}${r.val}`).join(', ');
        }

        function generateRuleOptions() {
            currentTask.ruleOptions = [];
            const correctRuleStr = currentTask.correctRuleString;
            currentTask.ruleOptions.push(correctRuleStr);

            let maxRuleValOption = 1;
            if (currentSettings.numberRangeMax === 5) maxRuleValOption = 1;
            else if (currentSettings.numberRangeMax === 10) maxRuleValOption = 2;
            else maxRuleValOption = 3;

            while (currentTask.ruleOptions.length < 4) {
                let ruleLength = currentTask.rule.length;
                let fakeRuleArr = [];
                let fakeRuleStr = "";
                let attempts = 0;

                do {
                    attempts++;
                    fakeRuleArr = [];
                    let madeChange = false; 
                    for (let i = 0; i < ruleLength; i++) {
                        let op = currentTask.rule[i].op;
                        let val = currentTask.rule[i].val;

                        if (attempts > 5 && Math.random() < 0.7) { 
                            if (Math.random() < 0.5) { 
                                op = op === '+' ? '-' : '+';
                                madeChange = true;
                            } else { 
                                let newVal;
                                do {
                                    newVal = getRandomInt(1, maxRuleValOption);
                                } while (newVal === val && maxRuleValOption > 1); 
                                if (newVal !== val) madeChange = true;
                                val = newVal;
                            }
                        } else if (attempts <= 5 && i === getRandomInt(0, ruleLength -1) ) {
                             if (Math.random() < 0.5) { op = op === '+' ? '-' : '+'; madeChange = true;}
                             else { 
                                 let tempVal = val;
                                 val = getRandomInt(1, maxRuleValOption); 
                                 if(val !== tempVal) madeChange = true;
                            }
                        } else { 
                            op = Math.random() < 0.5 ? '+' : '-';
                            val = getRandomInt(1, maxRuleValOption);
                        }
                        fakeRuleArr.push({op, val});
                    }
                    fakeRuleStr = fakeRuleArr.map(r => `${r.op}${r.val}`).join(', ');
                    
                    if (fakeRuleStr === correctRuleStr && !madeChange && ruleLength > 0 && attempts < 25) { 
                        let changeIndex = getRandomInt(0, ruleLength-1);
                        if (fakeRuleArr[changeIndex]) { 
                           fakeRuleArr[changeIndex].val = (fakeRuleArr[changeIndex].val % maxRuleValOption) + 1;
                           if(fakeRuleArr[changeIndex].val > maxRuleValOption) fakeRuleArr[changeIndex].val = 1;
                           fakeRuleStr = fakeRuleArr.map(r => `${r.op}${r.val}`).join(', ');
                        }
                    }
                } while ((currentTask.ruleOptions.includes(fakeRuleStr) || fakeRuleStr === correctRuleStr) && attempts < 50); 
                
                if (!currentTask.ruleOptions.includes(fakeRuleStr) && fakeRuleStr !== correctRuleStr) {
                    currentTask.ruleOptions.push(fakeRuleStr);
                } else if (attempts >= 50 && currentTask.ruleOptions.length < 4) { 
                    let randomOp = Math.random() < 0.5 ? '+' : '-';
                    let randomVal = getRandomInt(1, maxRuleValOption + 1); 
                    let fallbackRuleParts = [];
                    for(let k=0; k < ruleLength; k++){
                        fallbackRuleParts.push(`${randomOp}${randomVal + k + currentTask.ruleOptions.length}`);
                    }
                    let uniqueFallbackRule = fallbackRuleParts.join(', ');
                    if(!currentTask.ruleOptions.includes(uniqueFallbackRule) && uniqueFallbackRule !== correctRuleStr){
                       currentTask.ruleOptions.push(uniqueFallbackRule);
                    }
                }
            }
            while(currentTask.ruleOptions.length < 4 && currentTask.rule.length > 0){
                let lastOption = currentTask.ruleOptions[currentTask.ruleOptions.length-1] || correctRuleStr;
                let parts = lastOption.split(',');
                if (parts.length > 0 && parts[parts.length-1].length > 1) { 
                    let lastPartVal = parseInt(parts[parts.length-1].substring(1));
                    if (!isNaN(lastPartVal)) { 
                       parts[parts.length-1] = parts[parts.length-1][0] + (lastPartVal + 1);
                    } else { 
                       parts[parts.length-1] = parts[parts.length-1][0] + "1";
                    }
                } else { 
                     parts = [(Math.random() < 0.5 ? '+' : '-') + "1"];
                }
                let newOpt = parts.join(',');
                if(!currentTask.ruleOptions.includes(newOpt)) currentTask.ruleOptions.push(newOpt);
                else currentTask.ruleOptions.push(correctRuleStr + "_" + currentTask.ruleOptions.length); 
            }
            shuffleArray(currentTask.ruleOptions);
        }

        function renderSequenceStep() {
            sequenceDisplayArea.innerHTML = '';
            userSequenceInputs = []; 

            for (let i = 0; i < currentTask.sequence.length; i++) {
                const itemEl = document.createElement('div');
                itemEl.classList.add('sequence-item');

                if (i < currentTask.shownElements) { 
                    const numDisplay = document.createElement('div');
                    numDisplay.classList.add('number-display');
                    numDisplay.textContent = currentTask.sequence[i];
                    itemEl.appendChild(numDisplay);
                } else { 
                    const inputEl = document.createElement('input');
                    inputEl.type = 'number';
                    inputEl.min = 0;
                    inputEl.max = currentSettings.numberRangeMax;
                    inputEl.pattern = "\\d*"; 
                    inputEl.dataset.index = i - currentTask.shownElements; 
                    
                    inputEl.addEventListener('input', function() {
                        const valStr = this.value;
                        const expectedFullNumberForThisInput = currentTask.sequence[currentTask.shownElements + parseInt(this.dataset.index)];
                        
                        if (valStr.length >= String(expectedFullNumberForThisInput).length && valStr.length > 0) {
                             if (parseInt(valStr) > currentSettings.numberRangeMax) { 
                                this.value = valStr.slice(0, String(currentSettings.numberRangeMax).length); 
                                if (parseInt(this.value) > currentSettings.numberRangeMax) this.value = String(currentSettings.numberRangeMax);
                                return;
                            }
                            const nextInputIndex = parseInt(this.dataset.index) + 1;
                            if (nextInputIndex < currentTask.elementsToFill) { 
                                if (userSequenceInputs[nextInputIndex]) userSequenceInputs[nextInputIndex].focus();
                            } else {
                                checkSequenceButton.focus(); 
                            }
                        }
                    });
                    itemEl.appendChild(inputEl);
                    userSequenceInputs.push(inputEl); 
                }
                sequenceDisplayArea.appendChild(itemEl);

                // √öJ: Szab√°ly m≈±velet beviteli mez≈ë hozz√°ad√°sa felt√©telesen
                if (currentSettings.displayMode === 'reminder' && i < currentTask.shownElements - 1) {
                    const operatorInputContainer = document.createElement('div');
                    operatorInputContainer.classList.add('operator-input-item');
                    
                    const opInput = document.createElement('input');
                    opInput.type = 'text';
                    opInput.classList.add('rule-operator-input');
                    opInput.placeholder = "¬±?"; 
                    opInput.maxLength = 3; 
                    
                    operatorInputContainer.appendChild(opInput);
                    sequenceDisplayArea.appendChild(operatorInputContainer);
                }
            }
            if (userSequenceInputs.length > 0) {
                userSequenceInputs[0].focus();
            }
        }
        
        function renderRuleStep() {
            ruleOptionsContainer.innerHTML = '';
            ruleOptionsContainer.querySelectorAll('.rule-option-button').forEach(btn => btn.disabled = false); 
            currentTask.ruleOptions.forEach((ruleStr) => {
                const button = document.createElement('button');
                button.classList.add('rule-option-button');
                button.textContent = ruleStr;
                button.dataset.rule = ruleStr;
                button.addEventListener('click', function() {
                    selectedRuleOption = this.dataset.rule;
                    ruleOptionsContainer.querySelectorAll('.rule-option-button').forEach(btn => {
                        btn.classList.remove('selected');
                        btn.style.backgroundColor = ''; 
                        btn.style.color = '';
                        btn.style.borderColor = '';
                    });
                    this.classList.add('selected');
                    feedbackStep2.textContent = ''; feedbackStep2.className = 'feedback';
                });
                ruleOptionsContainer.appendChild(button);
            });
        }

        checkSequenceButton.addEventListener('click', function() {
            let allCorrect = true;
            let allFilled = true;

            userSequenceInputs.forEach((inputEl, index) => {
                const userAnswer = parseInt(inputEl.value);
                const correctAnswer = currentTask.sequence[currentTask.shownElements + index];
                
                inputEl.classList.remove('correct-input', 'incorrect-input');

                if (inputEl.value.trim() === "") {
                    allFilled = false;
                    inputEl.classList.add('incorrect-input');
                } else if (isNaN(userAnswer) || userAnswer !== correctAnswer) {
                    allCorrect = false;
                    inputEl.classList.add('incorrect-input');
                } else {
                    inputEl.classList.add('correct-input');
                }
            });

            if (!allFilled) {
                feedbackStep1.textContent = "K√©rlek, t√∂lts ki minden hi√°nyz√≥ sz√°mot!";
                feedbackStep1.className = 'feedback incorrect';
            } else if (allCorrect) {
                feedbackStep1.textContent = "A sorozat helyes! ‚úÖ Most v√°laszd ki a szab√°lyt!";
                feedbackStep1.className = 'feedback correct';
                checkSequenceButton.disabled = true;
                userSequenceInputs.forEach(input => input.disabled = true);
                step2Container.style.display = 'block';
                renderRuleStep();
                 if (ruleOptionsContainer.firstChild) ruleOptionsContainer.firstChild.focus(); 
            } else {
                feedbackStep1.textContent = "A sorozatban hiba van. üßê Ellen≈ërizd a pirossal jel√∂lt mez≈ëket!";
                feedbackStep1.className = 'feedback incorrect';
            }
        });

        checkRuleButton.addEventListener('click', function() {
            if (!selectedRuleOption) {
                feedbackStep2.textContent = "K√©rlek, v√°lassz egy szab√°lyt!";
                feedbackStep2.className = 'feedback incorrect';
                return;
            }

            const isCorrect = selectedRuleOption === currentTask.correctRuleString;
            feedbackStep2.textContent = isCorrect ? 
                `Helyes a szab√°ly! (${currentTask.correctRuleString}) Szuper vagy! üéâ` :
                `Ez nem a helyes szab√°ly. A j√≥ megold√°s: ${currentTask.correctRuleString}. Pr√≥b√°ld meg √∫jra a k√∂vetkez≈ë feladatn√°l!`;
            feedbackStep2.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
            
            checkRuleButton.disabled = true;
            ruleOptionsContainer.querySelectorAll('.rule-option-button').forEach(btn => {
                btn.disabled = true; 
                if (btn.dataset.rule === currentTask.correctRuleString && !isCorrect) {
                    btn.classList.add('selected'); 
                     btn.style.borderColor = getComputedStyle(document.body).getPropertyValue('--feedback-correct-border-color').trim() || 'green';
                } else if (btn.dataset.rule === selectedRuleOption && !isCorrect) {
                     btn.style.borderColor = getComputedStyle(document.body).getPropertyValue('--feedback-incorrect-border-color').trim() || 'red';
                } else if (btn.dataset.rule !== selectedRuleOption && btn.dataset.rule !== currentTask.correctRuleString) {
                    btn.style.opacity = "0.6"; 
                }
            });
        });

        newTaskButton.addEventListener('click', generateNewSequenceTask);

        document.addEventListener('DOMContentLoaded', () => {
            const initialThemeButton = themeSelector.querySelector('.theme-button[data-theme="theme-candy"]');
            if(initialThemeButton) currentSettings.theme = initialThemeButton.dataset.theme;
            else currentSettings.theme = themeSelector.querySelector('.theme-button').dataset.theme; 
            
            const initialRangeButton = rangeSelector.querySelector('.range-button.active');
            if (initialRangeButton) currentSettings.numberRangeMax = parseInt(initialRangeButton.dataset.range);

            const initialModeButton = modeSelector.querySelector('.mode-button.active'); // √öJ
            if (initialModeButton) currentSettings.displayMode = initialModeButton.dataset.mode;


            applyTheme(currentSettings.theme); // Ez most m√°r a m√≥dv√°laszt√≥ gombokat is be√°ll√≠tja
            generateNewSequenceTask();
        });
    </script>
</body>
</html>