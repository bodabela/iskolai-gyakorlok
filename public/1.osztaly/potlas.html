<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1. Osztály - Pótlás Táblázatban</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
        }

        .theme-selector, .range-selector {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        
        .control-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.95em;
            transition: color 0.5s ease;
        }
       
        .theme-button, .range-button {
            padding: 8px 12px;
            border: 1px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }
        .theme-button:hover, .range-button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        .theme-button.active, .range-button.active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px var(--theme-button-active-border-color, #000); 
            transform: translateY(1px);
        }

        .container {
            background-color: #ffffff;
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px; 
            text-align: center;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        
        h1, h2 {
            text-align: center;
            transition: color 0.5s ease;
        }
        h1 {
            font-size: clamp(1.8em, 5vw, 2.2em); 
            margin-bottom: 15px;
        }
        h2 {
            font-size: clamp(1.3em, 4vw, 1.6em); 
            margin-bottom: 25px;
        }
        .task {
            margin-bottom: 30px; 
            padding: 20px;
            border-radius: 10px;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .task-header h3 {
            margin-top: 0;
            margin-bottom: 0; 
            font-size: clamp(1.1em, 3.5vw, 1.3em); 
            transition: color 0.5s ease;
        }
        .new-task-button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 10px; 
        }

        .task p.instructions { 
            line-height: 1.6; 
            font-size: clamp(1em, 3vw, 1.1em); 
            margin-bottom: 10px; 
            transition: color 0.5s ease;
            text-align: center; 
        }

        .table-task-container {
            margin-top: 15px;
            overflow-x: auto;
            display: flex;
            justify-content: center;
        }

        .table-task table {
            width: auto; 
            min-width: 200px; 
            margin: 0; 
            border-collapse: collapse; 
            font-size: clamp(1em, 3vw, 1.2em);
            border: 2px solid var(--table-border-color, #ccc); 
            border-radius: 8px;
            transition: border-color 0.5s ease;
            table-layout: auto; 
        }

        .table-task th, .table-task td {
            border: 1px solid var(--table-cell-border-color, #ddd); 
            padding: clamp(3px, 0.8vw, 5px); 
            text-align: center;
            min-width: clamp(45px, 9vw, 55px);
            height: clamp(45px, 9vw, 55px);  
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            box-sizing: border-box;
            vertical-align: middle;
        }
        .table-task th { 
            font-weight: bold;
            background-color: var(--table-th-bg-color, #f0f0f0); 
            color: var(--table-th-text-color, #333); 
        }
                
        .table-task .table-input {
            width: clamp(40px, 8vw, 50px); 
            height: clamp(38px, 7.5vw, 45px);
            padding: clamp(6px, 1vw, 8px);    
            text-align: center;
            font-size: clamp(0.9em, 2.8vw, 1.1em); 
            font-weight: normal; 
            border-radius: 6px;
            border: 1px solid var(--input-border-color, #ccc); 
            background-color: var(--input-bg-color, #fff); /* Alapértelmezett, felülírja az oszlop-szin osztály */
            color: var(--input-text-color, #212529); /* Alapértelmezett, felülírja az oszlop-szin osztály */
            -moz-appearance: textfield;
            box-sizing: border-box;
            margin: auto; 
            display: block;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            transition: border-color 0.3s ease, border-width 0.3s ease;
        }
        .table-task input[type=number]::-webkit-outer-spin-button,
        .table-task input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .table-task .table-fixed-number {
            font-size: clamp(1.1em, 3.5vw, 1.3em); 
            font-weight: bold; 
            padding: clamp(5px, 1vw, 8px); 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--fixed-cell-text-color, #333); /* Alapértelmezett, felülírja az oszlop-szin osztály */
            background-color: var(--fixed-cell-bg-color, #e9ecef); /* Alapértelmezett, felülírja az oszlop-szin osztály */
            border-radius: 4px;
            min-width: clamp(40px, 8vw, 50px); 
            min-height: clamp(38px, 7.5vw, 45px); 
            box-sizing: border-box;
            border: 1px solid var(--fixed-cell-border-color, transparent);
            line-height: 1;
        }
        
        .table-task .target-sum-cell-styled .table-fixed-number { 
            font-size: clamp(1.2em, 3.8vw, 1.4em); 
            background-color: var(--target-sum-bg-color);
            color: var(--target-sum-text-color);
        }
        
        .table-task .empty-placeholder-cell { 
            border: none;
            background-color: transparent !important;
        }
      
        button.task-button { 
            padding: 10px 20px; 
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(1em, 3vw, 1.1em); 
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button.task-button:hover {
            transform: translateY(-2px);
        }
        button.task-button:active {
            transform: translateY(0px);
        }
        .feedback {
            margin-top: 10px; 
            font-weight: bold;
            padding: 8px; 
            border-radius: 6px;
            font-size: clamp(0.9em, 2.8vw, 1.05em); 
            transition: color 0.5s ease, background-color 0.5s ease, border-color 0.5s ease;
            min-height: 1.5em; 
        }
        
        :root {
            --table-border-color: #dee2e6;
            --table-cell-border-color: #e9ecef;
            --table-th-bg-color: #f8f9fa;
            --table-th-text-color: #495057;
            --fixed-cell-bg-color: #e9ecef; 
            --fixed-cell-text-color: #495057;
            --fixed-cell-border-color: #ced4da;
            --target-sum-bg-color: #FFD700; 
            --target-sum-text-color: #423A02; 
            --input-bg-color: #fff; 
            --input-text-color: #212529;
            --input-border-color: #ced4da;
            --feedback-correct-border-color: green;
            --feedback-incorrect-border-color: red;
            --feedback-border-width: 2.5px;

            /* Alapértelmezett oszlop színek */
            --oszlop-szin-1-eros: #f8d7da; --oszlop-szin-1-pasztell: #fde7e9;
            --oszlop-szin-2-eros: #cce5ff; --oszlop-szin-2-pasztell: #e7f2ff;
            --oszlop-szin-3-eros: #d4edda; --oszlop-szin-3-pasztell: #eaf7ec;
            --oszlop-szin-4-eros: #fff3cd; --oszlop-szin-4-pasztell: #fff9e7;
            --oszlop-szin-5-eros: #d1ecf1; --oszlop-szin-5-pasztell: #e8f7f9;
        }

        /* Téma-specifikus oszlop színek */
        body.theme-candy {
            --oszlop-szin-1-eros: #ffc0cb; --oszlop-szin-1-pasztell: #ffe4e1; /* Pinkek */
            --oszlop-szin-2-eros: #dda0dd; --oszlop-szin-2-pasztell: #f2dcf2; /* Lilák */
            --oszlop-szin-3-eros: #ffb6c1; --oszlop-szin-3-pasztell: #fff0f5; /* Világosabb pinkek */
            --oszlop-szin-4-eros: #db7093; --oszlop-szin-4-pasztell: #ffe4f0; /* Sötétebb rózsaszín */
            --oszlop-szin-5-eros: #ff7f50; --oszlop-szin-5-pasztell: #ffdab9; /* Korall/Barack */
        }
        body.theme-space {
            --oszlop-szin-1-eros: #3b82f6; --oszlop-szin-1-pasztell: #60a5fa; /* Kékek */
            --oszlop-szin-2-eros: #10b981; --oszlop-szin-2-pasztell: #34d399; /* Zöldek */
            --oszlop-szin-3-eros: #8b5cf6; --oszlop-szin-3-pasztell: #a78bfa; /* Lilák */
            --oszlop-szin-4-eros: #f59e0b; --oszlop-szin-4-pasztell: #fbbf24; /* Narancsok */
            --oszlop-szin-5-eros: #ec4899; --oszlop-szin-5-pasztell: #f472b6; /* Pinkek */
        }
        body.theme-jungle {
            --oszlop-szin-1-eros: #81c784; --oszlop-szin-1-pasztell: #a5d6a7; /* Világoszöld */
            --oszlop-szin-2-eros: #66bb6a; --oszlop-szin-2-pasztell: #81c784; /* Középzöld */
            --oszlop-szin-3-eros: #a1887f; --oszlop-szin-3-pasztell: #bcaaa4; /* Barna */
            --oszlop-szin-4-eros: #ffd54f; --oszlop-szin-4-pasztell: #ffe082; /* Sárga */
            --oszlop-szin-5-eros: #4db6ac; --oszlop-szin-5-pasztell: #80cbc4; /* Türkiz */
        }
        /* További témákhoz hasonlóan definiálhatóak az --oszlop-szin-X változók */


        /* Oszlop színező osztályok */
        .oszlop-szin-1 .table-fixed-number { background-color: var(--oszlop-szin-1-eros); color: var(--fixed-cell-text-color);}
        .oszlop-szin-1 .table-input { background-color: var(--oszlop-szin-1-pasztell); color: var(--input-text-color);}
        .oszlop-szin-2 .table-fixed-number { background-color: var(--oszlop-szin-2-eros); color: var(--fixed-cell-text-color);}
        .oszlop-szin-2 .table-input { background-color: var(--oszlop-szin-2-pasztell); color: var(--input-text-color);}
        .oszlop-szin-3 .table-fixed-number { background-color: var(--oszlop-szin-3-eros); color: var(--fixed-cell-text-color);}
        .oszlop-szin-3 .table-input { background-color: var(--oszlop-szin-3-pasztell); color: var(--input-text-color);}
        .oszlop-szin-4 .table-fixed-number { background-color: var(--oszlop-szin-4-eros); color: var(--fixed-cell-text-color);}
        .oszlop-szin-4 .table-input { background-color: var(--oszlop-szin-4-pasztell); color: var(--input-text-color);}
        .oszlop-szin-5 .table-fixed-number { background-color: var(--oszlop-szin-5-eros); color: var(--fixed-cell-text-color);}
        .oszlop-szin-5 .table-input { background-color: var(--oszlop-szin-5-pasztell); color: var(--input-text-color);}


        body.theme-candy { background-color: #fff0f5; color: #8a2be2; --theme-button-active-border-color: #da70d6;
            --table-border-color: #ffb6c1; --table-cell-border-color: #ffc0cb;
            --table-th-bg-color: #ffdae9; --table-th-text-color: #c71585;
            --fixed-cell-text-color: #9932cc; --fixed-cell-border-color: #ffc0cb;
            --target-sum-text-color: #7c0057; 
            --input-text-color: #8a2be2; --input-border-color: #ffb6c1;
            --feedback-correct-border-color: #90ee90; --feedback-incorrect-border-color: #ffb6c1;
        }
        body.theme-candy .control-label { color: #c71585; }
        body.theme-candy .theme-button.active, body.theme-candy .range-button.active { background-color: #ffb6c1; color: #7c3c60; }
        body.theme-candy .container { background-color: #ffe4e1; border-color: #ffc0cb; }
        body.theme-candy h1, body.theme-candy h2 { color: #da70d6; }
        body.theme-candy .task { background-color: #fffafa; border-color: #ffb6c1; }
        body.theme-candy .task-header h3 { color: #ff69b4; }
        body.theme-candy .task p.instructions { color: #8a2be2; }
        body.theme-candy button.task-button { background-color: #ff69b4; }
        body.theme-candy .feedback.correct { color: #228b22; background-color: #f0fff0; border-color: #90ee90; }
        body.theme-candy .feedback.incorrect { color: #dc143c; background-color: #fff0f5; border-color: #ffb6c1; }

        body.theme-space { background-color: #0f172a; color: #e2e8f0; --theme-button-active-border-color: #60a5fa;
            --table-border-color: #475569; --table-cell-border-color: #334155;
            --table-th-bg-color: #1e3a8a; --table-th-text-color: #93c5fd;
            --fixed-cell-text-color: #e2e8f0; --fixed-cell-border-color: #475569;
            --target-sum-text-color: #f0f9ff; 
            --input-text-color: #e2e8f0; --input-border-color: #475569;
            --feedback-correct-border-color: #22c55e; --feedback-incorrect-border-color: #ef4444;
        }
        body.theme-space .control-label { color: #93c5fd; }
        body.theme-space .theme-button.active, body.theme-space .range-button.active { background-color: #1e3a8a; color: #93c5fd; }
        body.theme-space .container { background-color: #1e293b; border-color: #334155; }
        body.theme-space h1, body.theme-space h2 { color: #60a5fa; }
        body.theme-space .task { background-color: #334155; border-color: #475569; }
        body.theme-space .task-header h3 { color: #93c5fd; }
        body.theme-space .task p.instructions { color: #cbd5e1; }
        body.theme-space button.task-button { background-color: #2563eb; }
        body.theme-space .feedback.correct { color: #4ade80; background-color: #162d22; border-color: #22c55e; }
        body.theme-space .feedback.incorrect { color: #f87171; background-color: #3f1a1a; border-color: #ef4444; }

        body.theme-jungle { background-color: #f0fff0; color: #1b5e20; --theme-button-active-border-color: #558b2f;
            --table-border-color: #558b2f; --table-cell-border-color: #81c784;
            --table-th-bg-color: #a5d6a7; --table-th-text-color: #2e7d32;
            --fixed-cell-text-color: #1b5e20; --fixed-cell-border-color: #a5d6a7;
            --target-sum-text-color: #143d06; 
            --input-text-color: #1b5e20; --input-border-color: #81c784;
            --feedback-correct-border-color: #a5d6a7; --feedback-incorrect-border-color: #ef9a9a;
        }
        body.theme-jungle .control-label { color: #558b2f; }
        body.theme-jungle .theme-button.active, body.theme-jungle .range-button.active { background-color: #689f38; color: #dcedc8; }
        body.theme-jungle .container { background-color: #e8f5e9; border-color: #a5d6a7; }
        body.theme-jungle h1, body.theme-jungle h2 { color: #388e3c; }
        body.theme-jungle .task { background-color: #dcedc8; border-color: #81c784; }
        body.theme-jungle .task-header h3 { color: #558b2f; }
        body.theme-jungle .task p.instructions { color: #2e7d32; }
        body.theme-jungle button.task-button { background-color: #7cb342; }
        body.theme-jungle .feedback.correct { color: #388e3c; background-color: #e8f5e9; border-color: #a5d6a7; }
        body.theme-jungle .feedback.incorrect { color: #d32f2f; background-color: #ffebee; border-color: #ef9a9a; }
        
        body.theme-magicforest { background-color: #e6e6fa; color: #483d8b; --theme-button-active-border-color: #8a2be2; } body.theme-magicforest .task p.instructions {color: #4b0082;} 
        body.theme-tech { background-color: #263238; color: #eceff1; --theme-button-active-border-color: #00acc1;} body.theme-tech .task p.instructions {color: #b0bec5;} 
        body.theme-ocean { background-color: #e0f7fa; color: #00796b; --theme-button-active-border-color: #20b2aa;} body.theme-ocean .task p.instructions {color: #00695c;} 
        body.theme-sport { background-color: #e3f2fd; color: #0d47a1; --theme-button-active-border-color: #d32f2f;} body.theme-sport .task p.instructions {color: #0d47a1;} 
        body.theme-flowergarden { background-color: #fffaf0; color: #556b2f; --theme-button-active-border-color: #ff6347;} body.theme-flowergarden .task p.instructions {color: #8b4513;} 
        body.theme-adventure { background-color: #f5f5dc; color: #5d4037; --theme-button-active-border-color: #bf360c;} body.theme-adventure .task p.instructions {color: #4e342e;} 
        body.theme-sky { background-color: #f0f8ff; color: #4682b4; --theme-button-active-border-color: #1e90ff;} body.theme-sky .task p.instructions {color: #5f9ea0;} 

    </style>
</head>
<body class="theme-candy"> 
    <div class="controls-container">
        <div>
            <p class="control-label">Téma választó:</p>
            <div class="theme-selector">
                <button class="theme-button" data-theme="theme-candy">Cukorka</button>
                <button class="theme-button" data-theme="theme-magicforest">Varázserdő</button>
                <button class="theme-button" data-theme="theme-ocean">Óceán</button>
                <button class="theme-button" data-theme="theme-flowergarden">Virágoskert</button>
                <button class="theme-button" data-theme="theme-sky">Égbolt</button>
                <button class="theme-button" data-theme="theme-space">Űr</button>
                <button class="theme-button" data-theme="theme-jungle">Őserdő</button>
                <button class="theme-button" data-theme="theme-tech">Techno</button>
                <button class="theme-button" data-theme="theme-sport">Sport</button>
                <button class="theme-button" data-theme="theme-adventure">Kaland</button>
            </div>
        </div>
        <div>
            <p class="control-label">Számkör választó:</p>
            <div class="range-selector">
                <button class="range-button" data-range="5">5-ös</button>
                <button class="range-button active" data-range="10">10-es</button>
                <button class="range-button" data-range="20">20-as</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>1. Osztály - Matematika Feladatok</h1>
        <h2>Téma: Pótlás Táblázatban</h2>

        <div class="task">
            <div class="task-header">
                <h3>1. Feladat: Mennyit adjak hozzá, hogy ... legyen?</h3>
                <button class="task-button new-task-button" onclick="generateTask1()">Új feladat</button>
            </div>
            <p id="task1_description_p" class="instructions">A számokat pótold a táblázat elején megadott számra! Írd a hiányzó mennyiséget a megfelelő helyre!</p>
            <div id="task1_table_container" class="table-task-container table-task">
                </div>
            <button class="task-button" onclick="checkTask1()">Ellenőrzés</button>
            <p id="task1_feedback" class="feedback"></p>
        </div>

        <div class="task">
             <div class="task-header">
                <h3>2. Feladat: Töltsd ki a táblázatot a szabály alapján!</h3>
                <button class="task-button new-task-button" onclick="generateTask2()">Új feladat</button>
            </div>
            <p id="task2_rule_p" class="instructions">Szabály: Y = X + ?</p>
            <div id="task2_table_container" class="table-task-container table-task">
                </div>
            <button class="task-button" onclick="checkTask2()">Ellenőrzés</button>
            <p id="task2_feedback" class="feedback"></p>
        </div>
    </div>

    <script>
        let currentNumberRange = 10; 
        let task1Data = { targetSum: 0, columns: [] }; 
        let task2Data = { rule: { variable1: 'Y', variable2: 'X', operation: '+', diff: 0},
                            tablePairs: [], solutions: {} };

        const bodyEl = document.body;
        const themeButtons = document.querySelectorAll('.theme-button');
        const rangeButtons = document.querySelectorAll('.range-button');
        const NUM_COLS_TASK1_TASK2 = 8; 

        const oszlopAlapSzinOsztalyok = [
            'oszlop-szin-1', 'oszlop-szin-2', 'oszlop-szin-3', 'oszlop-szin-4', 'oszlop-szin-5'
        ];
        
        function getUniqueClassFromArray(availableClassesArray) {
            if (!availableClassesArray || availableClassesArray.length === 0) {
                // Ha elfogytak az egyedi osztályok, válasszunk egyet véletlenszerűen az alap listából
                return oszlopAlapSzinOsztalyok[Math.floor(Math.random() * oszlopAlapSzinOsztalyok.length)];
            }
            const randomIndex = Math.floor(Math.random() * availableClassesArray.length);
            return availableClassesArray.splice(randomIndex, 1)[0]; 
        }
        
        function getDifferentClass(availableClassesArray, excludeClass = null) {
            let choice;
            let attempts = 0;
            const maxAttempts = availableClassesArray.length > 1 ? availableClassesArray.length * 2 : 1;
            if (availableClassesArray.length === 0) { // Fallback, ha a forrás tömb üres
                return oszlopAlapSzinOsztalyok[Math.floor(Math.random() * oszlopAlapSzinOsztalyok.length)];
            }
            do {
                choice = availableClassesArray[Math.floor(Math.random() * availableClassesArray.length)];
                attempts++;
            } while (excludeClass && choice === excludeClass && attempts < maxAttempts && availableClassesArray.length > 1);
            return choice;
        }

        function setupInputFocusAndMaxlength(inputElements, setInitialFocus = false) {
            inputElements.forEach((inputEl, index) => {
                if (!inputEl) return; 
                
                const expectedSolutionString = String(inputEl.dataset.expectedValue);
                const fieldMaxLengthBasedOnNumberRange = currentNumberRange > 9 ? 2 : 1;
                inputEl.setAttribute('maxlength', fieldMaxLengthBasedOnNumberRange);


                inputEl.style.borderColor = `var(--input-border-color, #ccc)`;
                inputEl.style.borderWidth = '1px';
                inputEl.style.borderStyle = 'solid';

                inputEl.addEventListener('input', () => {
                    const value = inputEl.value;
                    // Akkor lépjen tovább, ha a beírt érték hossza megegyezik a VÁRT megoldás hosszával
                    if (value.length >= expectedSolutionString.length && index < inputElements.length - 1) {
                         if(inputElements[index + 1]) inputElements[index + 1].focus();
                    }
                });
            });
            if (setInitialFocus && inputElements.length > 0 && inputElements[0]) {
                setTimeout(() => {
                    if (inputElements[0]) inputElements[0].focus();
                }, 50);
            }
        }

        function applyTheme(themeClass) {
            bodyEl.className = ''; 
            bodyEl.classList.add(themeClass); 
            themeButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.theme === themeClass));
            rangeButtons.forEach(btn => btn.classList.toggle('active', parseInt(btn.dataset.range) === currentNumberRange));
            // Téma váltásakor újra kell generálni a táblákat, hogy az új téma CSS változói érvényesüljenek a JS által beállított stílusokban is
            if (typeof generateTask1 === 'function' && typeof generateTask2 === 'function') { // Csak ha már definiálva vannak
                generateTask1();
                generateTask2();
            }
        }

        themeButtons.forEach(button => button.addEventListener('click', () => applyTheme(button.dataset.theme)));
        rangeButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentNumberRange = parseInt(button.dataset.range);
                rangeButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                generateTask1();
                generateTask2();
            });
        });
        
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            if (min > max) return min; 
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateTask1() {
            task1Data.targetSum = getRandomInt(Math.max(1, Math.floor(currentNumberRange / 2) + 1), currentNumberRange);
            if (currentNumberRange === 5 && task1Data.targetSum < 2) task1Data.targetSum = getRandomInt(2,5);
            else if (task1Data.targetSum < 1 && currentNumberRange > 0) task1Data.targetSum = 1;
            else if (currentNumberRange === 0 ) task1Data.targetSum = 0;

            task1Data.columns = [];
            const usedGivenNumbers = new Set();

            for (let i = 0; i < NUM_COLS_TASK1_TASK2; i++) {
                let givenNum;
                let attempts = 0;
                const maxAttempts = 50;
                let uniquePossible = (task1Data.targetSum +1) > usedGivenNumbers.size;

                do {
                    if (task1Data.targetSum === 0) givenNum = 0;
                    else givenNum = getRandomInt(0, task1Data.targetSum -1 );
                    attempts++;
                } while (usedGivenNumbers.has(givenNum) && attempts < maxAttempts && uniquePossible && usedGivenNumbers.size < (task1Data.targetSum +1) ); 
                
                if (usedGivenNumbers.has(givenNum) && uniquePossible && usedGivenNumbers.size < (task1Data.targetSum+1)) { 
                    for (let fallback = 0; fallback <= task1Data.targetSum; fallback++) {
                        if (!usedGivenNumbers.has(fallback)) {
                            givenNum = fallback;
                            break;
                        }
                    }
                }
                usedGivenNumbers.add(givenNum);
                const solutionNum = task1Data.targetSum - givenNum;
                const isGivenFixed = Math.random() < 0.5;

                task1Data.columns.push({
                    fixedValue: isGivenFixed ? givenNum : solutionNum,
                    valueToFind: isGivenFixed ? solutionNum : givenNum,
                    isFixedOnTop: Math.random() < 0.5, 
                    id: `task1_input_col${i}` 
                });
            }
            renderTask1Table();
            document.getElementById('task1_feedback').textContent = '';
            document.getElementById('task1_feedback').className = 'feedback';
            document.getElementById('task1_description_p').textContent = `A számokat pótold a táblázat elején megadott ${task1Data.targetSum} számra! Írd a hiányzó mennyiséget a megfelelő helyre!`;
        }

        function renderTask1Table() {
            const container = document.getElementById('task1_table_container');
            container.innerHTML = '';
            const table = document.createElement('table');
            
            const row1 = table.insertRow(); 
            const row2 = table.insertRow(); 
            const orderedInputs = [];
            let availableColorClassesForTask1 = [...oszlopAlapSzinOsztalyok]; 

            const targetCell = row1.insertCell();
            targetCell.classList.add('target-sum-cell-styled'); // CSS osztály a stílushoz
            targetCell.rowSpan = 2; 
            const targetWrapper = document.createElement('div');
            targetWrapper.classList.add('table-fixed-number'); 
            targetWrapper.textContent = task1Data.targetSum;
            // A stílust a .target-sum-cell-styled .table-fixed-number CSS szabály kezeli
            targetCell.appendChild(targetWrapper);
            
            task1Data.columns.forEach((colData) => {
                const cellTop = row1.insertCell();
                const cellBottom = row2.insertCell();
                
                const colorClass = getUniqueClassFromArray(availableColorClassesForTask1);
                // Az osztályt a td elemek kapják, hogy a bennük lévő input/fixed-number örökölhesse
                cellTop.classList.add(colorClass);
                cellBottom.classList.add(colorClass);


                const fixedEl = document.createElement('div');
                fixedEl.classList.add('table-fixed-number');
                fixedEl.textContent = colData.fixedValue;
                // Háttér és szövegszín a CSS osztályból jön

                const inputEl = document.createElement('input');
                inputEl.type = 'number';
                inputEl.classList.add('table-input');
                inputEl.id = colData.id; 
                inputEl.min = 0;
                inputEl.max = currentNumberRange;
                inputEl.dataset.expectedValue = colData.valueToFind; 
                // Háttér és szövegszín a CSS osztályból jön

                if (colData.isFixedOnTop) {
                    cellTop.appendChild(fixedEl);
                    cellBottom.appendChild(inputEl);
                } else {
                    cellTop.appendChild(inputEl);
                    cellBottom.appendChild(fixedEl);
                }
                orderedInputs.push(inputEl);
            });
            container.appendChild(table);
            setupInputFocusAndMaxlength(orderedInputs, true); 
        }

        function checkTask1() {
            const feedbackEl = document.getElementById('task1_feedback');
            let allCorrect = true;
            let allFilled = true;
            const borderWidth = getComputedStyle(document.documentElement).getPropertyValue('--feedback-border-width').trim();

            task1Data.columns.forEach((colData) => {
                const inputEl = document.getElementById(colData.id);
                if (!inputEl || !inputEl.closest('td')) return;  
                
                if (inputEl.value.trim() === "") {
                    allFilled = false;
                    inputEl.style.borderColor = `var(--feedback-incorrect-border-color)`;
                } else {
                    const userAnswer = parseInt(inputEl.value);
                    if (userAnswer !== colData.valueToFind) { 
                        allCorrect = false;
                        inputEl.style.borderColor = `var(--feedback-incorrect-border-color)`;
                    } else {
                        inputEl.style.borderColor = `var(--feedback-correct-border-color)`;
                    }
                }
                inputEl.style.borderWidth = borderWidth;
                inputEl.style.borderStyle = 'solid';
            });

            if (!allFilled) {
                 feedbackEl.textContent = 'Még nem töltöttél ki minden mezőt!';
                 feedbackEl.className = 'feedback incorrect';
            } else if (allCorrect) {
                feedbackEl.textContent = 'Ügyes vagy, minden pótlás helyes!';
                feedbackEl.className = 'feedback correct';
            } else {
                feedbackEl.textContent = 'Van hibás válasz. Nézd át a pirossal jelölteket!';
                feedbackEl.className = 'feedback incorrect';
            }
        }

        function generateTask2() {
            const diff = getRandomInt(1, Math.min(5, currentNumberRange >=1 ? Math.max(1, currentNumberRange -1) : 1)); 
            const operations = ['+', '-'];
            const operation = operations[Math.floor(Math.random() * operations.length)];
            
            task2Data.rule.operation = operation;
            task2Data.rule.diff = diff;

            const ruleP = document.getElementById('task2_rule_p');
            if (operation === '+') { 
                ruleP.textContent = `Szabály: Y = X + ${diff} (vagy másképp: X = Y - ${diff})`;
            } else { 
                ruleP.textContent = `Szabály: Y = X - ${diff} (vagy másképp: X = Y + ${diff})`;
            }

            task2Data.tablePairs = [];
            task2Data.solutions = {};
            const knownValuesThisTask = { X: new Set(), Y: new Set() };

            for (let i = 0; i < NUM_COLS_TASK1_TASK2; i++) {
                let xVal, yVal;
                let knownVar = (Math.random() < 0.5) ? 'X' : 'Y';
                let attempts = 0;

                do {
                    attempts++;
                    if (knownVar === 'X') {
                        if (operation === '+') { 
                            xVal = getRandomInt(0, currentNumberRange - diff);
                            yVal = xVal + diff;
                        } else { 
                            xVal = getRandomInt(diff, currentNumberRange);
                            yVal = xVal - diff;
                        }
                    } else { 
                        if (operation === '+') { 
                            yVal = getRandomInt(diff, currentNumberRange);
                            xVal = yVal - diff;
                        } else { 
                            yVal = getRandomInt(0, currentNumberRange - diff);
                            xVal = yVal + diff;
                        }
                    }
                    if (xVal < 0 || xVal > currentNumberRange || yVal < 0 || yVal > currentNumberRange) {
                        continue; 
                    }

                } while ( ((knownVar === 'X' && knownValuesThisTask.X.has(xVal)) || (knownVar === 'Y' && knownValuesThisTask.Y.has(yVal)) ) && attempts < 50);
                
                if (attempts >= 50 && ((knownVar === 'X' && knownValuesThisTask.X.has(xVal)) || (knownVar === 'Y' && knownValuesThisTask.Y.has(yVal)))) {
                    let foundFallback = false;
                    if (knownVar === 'X') {
                        for(let fx = 0; fx <= currentNumberRange - (operation === '+' ? diff : 0); fx++) {
                            if (!knownValuesThisTask.X.has(fx)) { xVal = fx; yVal = operation === '+' ? fx+diff : fx-diff; if (yVal >=0 && yVal <= currentNumberRange) {foundFallback=true; break;}}
                        }
                    } else {
                         for(let fy = (operation === '+' ? diff : 0); fy <= currentNumberRange - (operation === '-' ? diff : 0); fy++) {
                            if (!knownValuesThisTask.Y.has(fy)) { yVal = fy; xVal = operation === '+' ? fy-diff : fy+diff; if (xVal >=0 && xVal <= currentNumberRange) {foundFallback=true; break;}}
                        }
                    }
                     if (!foundFallback) { 
                         if (task2Data.tablePairs.length < NUM_COLS_TASK1_TASK2 -1 || task2Data.tablePairs.length === 0) {i--; continue;} else break;
                    }
                }
                if (xVal < 0 || xVal > currentNumberRange || yVal < 0 || yVal > currentNumberRange) {
                     if (task2Data.tablePairs.length < NUM_COLS_TASK1_TASK2 -1 || task2Data.tablePairs.length === 0) {i--; continue;} else break;
                }

                if (knownVar === 'X') knownValuesThisTask.X.add(xVal); else knownValuesThisTask.Y.add(yVal);

                task2Data.tablePairs.push({ 
                    x: (knownVar === 'X' ? xVal : null), 
                    y: (knownVar === 'Y' ? yVal : null),
                    xInputId: (knownVar === 'Y' ? `task2_x_col${i}` : null),
                    yInputId: (knownVar === 'X' ? `task2_y_col${i}` : null) 
                });
                task2Data.solutions[`x_col${i}`] = xVal;
                task2Data.solutions[`y_col${i}`] = yVal;
            }
            renderTask2Table();
            document.getElementById('task2_feedback').textContent = '';
            document.getElementById('task2_feedback').className = 'feedback';
        }

        function renderTask2Table() {
            const container = document.getElementById('task2_table_container');
            container.innerHTML = '';
            if (task2Data.tablePairs.length === 0) return;
            const table = document.createElement('table');
            const orderedInputs = [];
            let availableClassesForX = [...oszlopAlapSzinOsztalyok];
            let availableClassesForY = [...oszlopAlapSzinOsztalyok];

            const xColorClass = getDifferentClass(availableClassesForX);
            const yColorClass = getDifferentClass(availableClassesForY, xColorClass); // Próbáljon meg mást, mint X

            
            const xRow = table.insertRow();
            const xHeaderCell = xRow.insertCell();
            xHeaderCell.outerHTML = "<th class='header-cell-xy'>X</th>";
            
            task2Data.tablePairs.forEach((pair, i) => {
                const cell = xRow.insertCell();
                cell.classList.add(xColorClass); // Sor színezése
                if (pair.x !== null) {
                    const numDisplay = document.createElement('div');
                    numDisplay.classList.add('table-fixed-number');
                    numDisplay.textContent = pair.x;
                    cell.appendChild(numDisplay);
                } else {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.classList.add('table-input');
                    input.id = pair.xInputId; 
                    input.min = 0;
                    input.max = currentNumberRange;
                    input.dataset.expectedValue = task2Data.solutions[`x_col${i}`]; 
                    cell.appendChild(input);
                }
            });

            const yRow = table.insertRow();
            const yHeaderCell = yRow.insertCell();
            yHeaderCell.outerHTML = "<th class='header-cell-xy'>Y</th>";

            task2Data.tablePairs.forEach((pair, i) => {
                const cell = yRow.insertCell();
                cell.classList.add(yColorClass); // Sor színezése
                if (pair.y !== null) {
                    const numDisplay = document.createElement('div');
                    numDisplay.classList.add('table-fixed-number');
                    numDisplay.textContent = pair.y;
                    cell.appendChild(numDisplay);
                } else {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.classList.add('table-input');
                    input.id = pair.yInputId;
                    input.min = 0;
                    input.max = currentNumberRange;
                    input.dataset.expectedValue = task2Data.solutions[`y_col${i}`];
                    cell.appendChild(input);
                }
            });
            container.appendChild(table);

            for (let i = 0; i < NUM_COLS_TASK1_TASK2; i++) {
                const pair = task2Data.tablePairs[i];
                if (pair) {
                    if (pair.x === null && pair.xInputId) {
                        const inputEl = document.getElementById(pair.xInputId);
                        if (inputEl) orderedInputs.push(inputEl);
                    } else if (pair.y === null && pair.yInputId) { 
                        const inputEl = document.getElementById(pair.yInputId);
                        if (inputEl) orderedInputs.push(inputEl);
                    }
                }
            }
            setupInputFocusAndMaxlength(orderedInputs, false); 
        }

        function checkTask2() {
            const feedbackEl = document.getElementById('task2_feedback');
            let allCorrect = true;
            let allFilled = true;
            const borderWidth = getComputedStyle(document.documentElement).getPropertyValue('--feedback-border-width').trim();

            task2Data.tablePairs.forEach((pair, i) => {
                const checkInput = (inputId, solutionKey) => {
                    // Azért kell a pair[solutionKey.charAt(0)], hogy tudjuk, eredetileg X vagy Y volt-e null az adott oszlopban
                    if (pair[solutionKey.charAt(0)] === null && inputId) { 
                        const inputEl = document.getElementById(inputId);
                        if (!inputEl) return;
                        if (inputEl.value.trim() === "") {
                            allFilled = false;
                            inputEl.style.borderColor = `var(--feedback-incorrect-border-color)`;
                        } else {
                            const userAnswer = parseInt(inputEl.value);
                            if (userAnswer !== task2Data.solutions[solutionKey]) {
                                allCorrect = false;
                                inputEl.style.borderColor = `var(--feedback-incorrect-border-color)`;
                            } else {
                                inputEl.style.borderColor = `var(--feedback-correct-border-color)`;
                            }
                        }
                        inputEl.style.borderWidth = borderWidth;
                        inputEl.style.borderStyle = 'solid';
                    }
                };
                checkInput(pair.xInputId, `x_col${i}`);
                checkInput(pair.yInputId, `y_col${i}`);
            });
            
            if (!allFilled) {
                 feedbackEl.textContent = 'Még nem töltöttél ki minden üres mezőt!';
                 feedbackEl.className = 'feedback incorrect';
            } else if (allCorrect) {
                feedbackEl.textContent = 'Helyes! Ügyesen alkalmaztad a szabályt.';
                feedbackEl.className = 'feedback correct';
            } else {
                feedbackEl.textContent = 'Van hibás válasz. Ellenőrizd a pirossal jelölteket és a szabályt!';
                feedbackEl.className = 'feedback incorrect';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Téma osztály inicializálása a body-ról, ha van
            let initialTheme = 'theme-candy'; // Alapértelmezett
            for (let i = 0; i < bodyEl.classList.length; i++) {
                if (bodyEl.classList[i].startsWith('theme-')) {
                    initialTheme = bodyEl.classList[i];
                    break;
                }
            }
            applyTheme(initialTheme); 
            // generateTask1 és generateTask2 az applyTheme-ben is meghívódik,
            // így itt már nem kell külön, hogy elkerüljük a dupla generálást induláskor.
        });
    </script>
</body>
</html>