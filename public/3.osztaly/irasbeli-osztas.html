<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Írásbeli Osztás Gyakorló</title>
    <link href="https://fonts.googleapis.com/css2?family=Arial:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width:100%;
        }
         .settings-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-label {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.95em;
            transition: color 0.5s ease;
        }

        .setting-button {
            padding: 8px 12px;
            border: 1px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, transform 0.2s ease;
        }
        .setting-button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        .setting-button.active {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px var(--theme-button-active-border-color, #000);
            transform: translateY(1px);
        }

        .container {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 900px;
            text-align: center;
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        h1, h2 {
            text-align: center;
            transition: color 0.5s ease;
        }
        h1 {
            font-size: clamp(1.8em, 5vw, 2.2em);
            margin-bottom: 15px;
        }
        h2 {
            font-size: clamp(1.3em, 4vw, 1.6em);
            margin-bottom: 25px;
        }
        .task {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            transition: background-color 0.5s ease, border-color 0.5s ease;
            position: relative;
        }
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .task-header h3 {
            margin-top: 0;
            margin-bottom: 0;
            font-size: clamp(1.1em, 3.5vw, 1.3em);
            transition: color 0.5s ease;
        }
        .new-task-button {
            padding: 6px 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .task p {
            line-height: 1.6;
            font-size: clamp(1em, 3vw, 1.1em);
            margin-bottom: 10px;
            transition: color 0.5s ease;
        }
        
        button.task-button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: clamp(1em, 3vw, 1.1em);
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        button.task-button:hover {
            transform: translateY(-2px);
        }
        button.task-button:active {
            transform: translateY(0px);
        }

        .feedback {
            margin-top: 10px;
            font-weight: bold;
            padding: 8px;
            border-radius: 6px;
            font-size: clamp(0.9em, 2.8vw, 1.05em);
            transition: color 0.5s ease, background-color 0.5s ease, border-color 0.5s ease;
        }

        .main-division-grid {
            display: grid;
            gap: 1px; 
            justify-content: center; 
            margin: 1rem auto; 
            font-size: 1.5em; 
        }

        .grid-cell {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px; 
            line-height: 30px; 
            border-radius: 4px; 
            box-sizing: border-box;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        .grid-cell.dividend-digit {
            /* Osztandó számjegyeinek stílusa */
        }
        .grid-cell.current-dividend-part {
             /* Téma felülírja */
        }
        .grid-cell.op-symbol {
            font-weight: bold;
        }
         .grid-cell.brought-down-digit {
            font-weight: bold;
        }

        .grid-cell input.styled-input {
            width: 100%;
            height: 100%;
            font-size: inherit; 
            padding: 0;
            margin: 0;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #ccc; 
            box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);
            box-sizing: border-box;
        }
        .grid-cell input.styled-input:disabled {
             font-weight: bold;
             background-color: #e9ecef; 
        }
        
        .division-line-hr-grid {
            height: 1.5px;
            border: none;
            margin: 1px 0; 
            align-self: center; 
        }
        
        .final-remainder-display {
            margin-top: 0.8rem;
            font-weight: bold;
            font-size: 1.1em;
            text-align: right; 
            /* Igazítás a gridhez, ha a grid is középre van igazítva */
            /* Ezt a JS dinamikusan állíthatja a grid tényleges szélessége alapján */
        }
        
        /* Alapértelmezett Téma Stílusok (Candy lesz az alap) */
        .setting-button { background-color: #e0e0e0; color: #333; border: 1px solid #ccc; }
        .task-button { background-color: #007bff; color: white; }
        .container { background-color: #ffffff; border: 1px solid #e5e7eb; }
        .task { background-color: #f9fafb; border: 1px dashed #d1d5db; }
        .feedback.correct { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; }
        .feedback.incorrect { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .grid-cell input.styled-input { border: 1px solid #d1d5db; background-color: #fff; color: #333; }
        .grid-cell input.styled-input:disabled { background-color: #e9ecef; color: #495057; }
        .division-line-hr-grid { background-color: #6c757d; }
        .control-label { color: #333; }
        h1, h2 { color: #007bff; }
        .grid-cell.dividend-digit { color: #212529; }
        .grid-cell.current-dividend-part { background-color: #cfe2ff; box-shadow: 0 0 0 2px #0d6efd; }
        .grid-cell.brought-down-digit { color: #0d6efd; }
        .final-remainder-display { color: #333; }
        .grid-cell.op-symbol { color: #212529; }

        /* --- Csak a Candy Téma --- */
        body.theme-candy { background-color: #fff0f5; color: #8a2be2; --theme-button-active-border-color: #da70d6;}
        body.theme-candy .control-label { color: #c71585; }
        body.theme-candy .setting-button { background-color: #ffc0cb; color: #800080; border-color: #ffb6c1;}
        body.theme-candy .setting-button.active { background-color: #ffb6c1; color: #7c3c60; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2), 0 0 0 2px var(--theme-button-active-border-color, #da70d6); }
        body.theme-candy .container { background-color: #ffe4e1; border: 2px solid #ffc0cb; }
        body.theme-candy h1, body.theme-candy h2 { color: #da70d6; }
        body.theme-candy .task { background-color: #fffafa; border: 2px dashed #ffb6c1; }
        body.theme-candy .task-header h3 { color: #ff69b4; }
        body.theme-candy .task p { color: #8a2be2; }
        body.theme-candy .grid-cell.dividend-digit { color: #9932cc; }
        body.theme-candy .grid-cell input.styled-input { border: 2px solid #ffb6c1; color: #800080; background-color: #fffafa; }
        body.theme-candy .grid-cell input.styled-input:disabled { background-color: #ffe4e1; color: #c71585; }
        body.theme-candy button.task-button { background-color: #ff69b4; color: white; }
        body.theme-candy button.task-button:hover { background-color: #ff1493; }
        body.theme-candy .feedback.correct { color: #228b22; background-color: #f0fff0; border: 1px solid #90ee90; }
        body.theme-candy .feedback.incorrect { color: #dc143c; background-color: #fff0f5; border: 1px solid #ffb6c1; }
        body.theme-candy .division-line-hr-grid { background-color: #ffb6c1; }
        body.theme-candy .grid-cell.current-dividend-part { background-color: #ffeff2; box-shadow: 0 0 0 2px #ff69b4; }
        body.theme-candy .grid-cell.brought-down-digit { color: #ff1493; }
        body.theme-candy .final-remainder-display { color: #9932cc; }
        body.theme-candy .grid-cell.op-symbol { color: #9932cc; }

    </style>
</head>
<body>

    <div class="controls-container">
        <div class="w-full mt-4">
            <p class="control-label text-center">Beállítások:</p>
            <div class="settings-row">
                <div class="settings-group">
                    <p class="control-label">Osztandó:</p>
                    <div id="dividendLengthSelector" class="flex justify-center gap-2">
                        <button class="setting-button" data-length="2">2-jegyű</button>
                        <button class="setting-button" data-length="3">3-jegyű</button>
                    </div>
                </div>
                <div class="settings-group">
                    <p class="control-label">Maradék:</p>
                    <div id="remainderTypeSelector" class="flex flex-wrap justify-center gap-2">
                        <button class="setting-button" data-remainder="none">Nincs</button>
                        <button class="setting-button" data-remainder="with">Van</button>
                        <button class="setting-button" data-remainder="mixed">Vegyes</button>
                    </div>
                </div>
                <div class="settings-group">
                    <p class="control-label">Segítség:</p>
                    <div id="helpLevelSelector" class="flex justify-center gap-2">
                        <button class="setting-button" data-help="independent">Önálló</button>
                        <button class="setting-button" data-help="step-by-step">Lépésenként</button>
                        <button class="setting-button" data-help="guided">Vezetett</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>Írásbeli Osztás Gyakorló</h1>
        <h2>3. Osztály</h2>

        <div class="task">
            <div class="task-header">
                <h3>Feladat:</h3>
                <button id="newTaskButton" class="task-button new-task-button">Új feladat</button>
            </div>
            <p id="taskInstructions">Végezd el az osztást lépésről lépésre!</p>

            <div id="mainDivisionGrid" class="main-division-grid">
                </div>
            
            <div id="finalRemainderArea" class="final-remainder-display">
                Maradék: <span id="finalRemainderValue">-</span>
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button id="checkStepButton" class="task-button">Ellenőrzés</button>
            </div>
            <p id="feedbackArea" class="feedback" style="margin-top: 15px;">&nbsp;</p>
        </div>
    </div>

    <script>
        // DOM Elemek
        const dividendLengthSelector = document.getElementById('dividendLengthSelector');
        const remainderTypeSelector = document.getElementById('remainderTypeSelector');
        const helpLevelSelector = document.getElementById('helpLevelSelector');
        const newTaskButton = document.getElementById('newTaskButton');
        const checkStepButton = document.getElementById('checkStepButton');
        const taskInstructions = document.getElementById('taskInstructions');
        const mainDivisionGrid = document.getElementById('mainDivisionGrid'); 
        const finalRemainderValueEl = document.getElementById('finalRemainderValue');
        const feedbackArea = document.getElementById('feedbackArea');
        const bodyEl = document.body;

        let currentSettings = {
            theme: 'theme-candy', 
            dividendLength: 3,
            remainderType: 'none',
            helpLevel: 'step-by-step'
        };

        let task = {
            dividend: 0,
            divisor: 0,
            quotientDigits: [], 
            finalRemainder: 0,
            steps: [] 
        };
        
        let currentStepIndex = 0;
        let currentSubStep = 'estimate'; 
        let mainGridCurrentRow = 1; 

        // Event Listeners
        dividendLengthSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('setting-button')) {
                currentSettings.dividendLength = parseInt(e.target.dataset.length);
                updateActiveButtonVisuals(dividendLengthSelector, e.target);
                generateNewTask();
            }
        });
        remainderTypeSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('setting-button')) {
                currentSettings.remainderType = e.target.dataset.remainder;
                updateActiveButtonVisuals(remainderTypeSelector, e.target);
                generateNewTask();
            }
        });
        helpLevelSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('setting-button')) {
                currentSettings.helpLevel = e.target.dataset.help;
                updateActiveButtonVisuals(helpLevelSelector, e.target);
                checkStepButton.textContent = currentSettings.helpLevel === 'independent' ? 'Teljes ellenőrzés' : 'Lépés ellenőrzése';
                generateNewTask();
            }
        });

        newTaskButton.addEventListener('click', generateNewTask);
        checkStepButton.addEventListener('click', handleCheck);

        // Functions
        function applyTheme() {
            bodyEl.className = '';
            bodyEl.classList.add(currentSettings.theme); 
            updateActiveButtonVisuals(dividendLengthSelector, dividendLengthSelector.querySelector(`[data-length="${currentSettings.dividendLength}"]`));
            updateActiveButtonVisuals(remainderTypeSelector, remainderTypeSelector.querySelector(`[data-remainder="${currentSettings.remainderType}"]`));
            updateActiveButtonVisuals(helpLevelSelector, helpLevelSelector.querySelector(`[data-help="${currentSettings.helpLevel}"]`));
        }
        
        function updateActiveButtonVisuals(container, activeButton) {
            if (!container || !activeButton) return;
            container.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
            activeButton.classList.add('active');
        }

        function generateNewTask() {
            currentStepIndex = 0;
            currentSubStep = 'estimate';
            mainGridCurrentRow = 1;
            task = { dividend: 0, divisor: 0, quotientDigits: [], finalRemainder: 0, steps: [] };
            mainDivisionGrid.innerHTML = ''; 
            finalRemainderValueEl.textContent = '-';
            feedbackArea.textContent = '\u00A0';
            feedbackArea.className = 'feedback mt-4';
            
            task.divisor = Math.floor(Math.random() * 8) + 2; 

            let minDividend = currentSettings.dividendLength === 2 ? task.divisor : task.divisor * 10; 
            if (currentSettings.dividendLength === 2) minDividend = Math.max(10, task.divisor);
            else minDividend = Math.max(100, task.divisor);

            let maxDividend = currentSettings.dividendLength === 2 ? 99 : 999;
            
            let foundSuitableDividend = false;
            let attempts = 0;
            while(!foundSuitableDividend && attempts < 200) { 
                task.dividend = Math.floor(Math.random() * (maxDividend - minDividend + 1)) + minDividend;
                let tempRemainder = task.dividend % task.divisor;

                if (currentSettings.remainderType === 'none' && tempRemainder === 0) foundSuitableDividend = true;
                else if (currentSettings.remainderType === 'with' && tempRemainder !== 0) foundSuitableDividend = true;
                else if (currentSettings.remainderType === 'mixed') foundSuitableDividend = true;
                
                if (foundSuitableDividend) {
                    const dividendStr = String(task.dividend);
                    let firstPartToDivide = parseInt(dividendStr[0]);
                    if (firstPartToDivide < task.divisor && dividendStr.length > 1) {
                        firstPartToDivide = parseInt(dividendStr.substring(0,2));
                    }
                    if (firstPartToDivide < task.divisor) { 
                         if (dividendStr.length === currentSettings.dividendLength) foundSuitableDividend = false; 
                    }
                }
                attempts++;
            }
             if (!foundSuitableDividend) { 
                task.dividend = currentSettings.dividendLength === 2 ? task.divisor * (Math.floor(Math.random()*8)+2) : task.divisor * (Math.floor(Math.random()*80)+12);
                if (currentSettings.remainderType === 'with' && task.dividend % task.divisor === 0 && task.divisor > 1) {
                    if (task.dividend < maxDividend) task.dividend +=1; else task.dividend -= (task.divisor-1);
                }
                else if (currentSettings.remainderType === 'none') task.dividend -= (task.dividend % task.divisor);
                if (task.dividend < minDividend) task.dividend = minDividend + (task.dividend % task.divisor === 0 ? 0 : task.divisor - (task.dividend % task.divisor));

            }


            calculateCorrectSteps();
            renderTaskDisplay(); 
            prepareCurrentStepInputs();
            updateTaskInstructions();
        }

      function calculateCorrectSteps() {
            let dividendStr = String(task.dividend);
            let currentRemainderForNextStep = 0; 
            task.steps = [];
            task.quotientDigits = [];
            
            for (let i = 0; i < dividendStr.length; i++) {
                let digitBroughtDown = dividendStr[i];
                let currentDividendPartNum = currentRemainderForNextStep * 10 + parseInt(digitBroughtDown);
                
                if (currentDividendPartNum >= task.divisor || task.quotientDigits.length > 0 || i === dividendStr.length - 1) {
                    let quotientDigit = Math.floor(currentDividendPartNum / task.divisor);
                    let multiplyResult = quotientDigit * task.divisor;
                    let subtractResult = currentDividendPartNum - multiplyResult;

                    task.quotientDigits.push(quotientDigit);
                    task.steps.push({
                        currentDividendPartNumForStep: currentDividendPartNum,
                        baseDigitIndexOfOriginalPartEnd: i, 
                        quotientDigit: quotientDigit,
                        multiplyResult: multiplyResult,
                        subtractResult: subtractResult,
                        digitBroughtDownForThisPart: digitBroughtDown,
                        nextDigitToBringDown: (i + 1 < dividendStr.length) ? dividendStr[i + 1] : null
                    });
                    currentRemainderForNextStep = subtractResult;
                } else {
                    currentRemainderForNextStep = currentDividendPartNum;
                }
            }
            task.finalRemainder = currentRemainderForNextStep;

            if (task.quotientDigits.length === 0 && task.dividend < task.divisor) {
                 task.quotientDigits.push(0);
                 task.steps.push({
                    currentDividendPartNumForStep: task.dividend,
                    baseDigitIndexOfOriginalPartEnd: dividendStr.length - 1,
                    quotientDigit: 0,
                    multiplyResult: 0,
                    subtractResult: task.dividend,
                    digitBroughtDownForThisPart: dividendStr[dividendStr.length-1], 
                    nextDigitToBringDown: null
                });
                task.finalRemainder = task.dividend;
            }
        }

        function renderTaskDisplay() {
            mainDivisionGrid.innerHTML = ''; 
            const dividendStr = String(task.dividend);
            const divisorStr = String(task.divisor);
            const quotientLength = task.quotientDigits.length;

            // Oszlopok: 1 (operátor helye) + osztandó + 1 (:) + osztó + 1 (=) + hányados
            const numCols = 1 + dividendStr.length + 1 + divisorStr.length + 1 + quotientLength;
            mainDivisionGrid.style.gridTemplateColumns = `repeat(${numCols}, 30px)`;

            let currentCol = 1; 

            // 1. oszlop: Üres hely a mínusz jelnek a munkaterületen
            mainDivisionGrid.appendChild(createGridCell(null, mainGridCurrentRow, currentCol++));

            // Osztandó
            for (let i = 0; i < dividendStr.length; i++) {
                const cell = createGridCell(dividendStr[i], mainGridCurrentRow, currentCol++, ['dividend-digit']);
                cell.dataset.originalDividendIndex = i; 
                mainDivisionGrid.appendChild(cell);
            }
            
            mainDivisionGrid.appendChild(createGridCell(':', mainGridCurrentRow, currentCol++, ['op-symbol']));
            
            for (let i = 0; i < divisorStr.length; i++) {
                mainDivisionGrid.appendChild(createGridCell(divisorStr[i], mainGridCurrentRow, currentCol++));
            }

            mainDivisionGrid.appendChild(createGridCell('=', mainGridCurrentRow, currentCol++, ['op-symbol']));

            for (let i = 0; i < quotientLength; i++) {
                const input = createStyledInput(true, i, 'quotient'); 
                const cell = createGridCell(null, mainGridCurrentRow, currentCol++);
                cell.appendChild(input);
                mainDivisionGrid.appendChild(cell);
            }
            mainGridCurrentRow++; 
        }
        
        function createGridCell(content, row, col, classList = []) {
            const cell = document.createElement('div');
            cell.classList.add('grid-cell', ...classList);
            if (content !== null) cell.textContent = content;
            cell.style.gridRow = row;
            cell.style.gridColumn = `${col} / span 1`;
            return cell;
        }

        function createStyledInput(disabled, dataIndex = null, type = null) {
            const input = document.createElement('input');
            input.type = 'text';
            input.classList.add('styled-input');
            if (type === 'quotient') input.classList.add('quotient-digit-input');
            else if (type) input.classList.add(`${type}-digit-value`);
            
            input.maxLength = 1;
            input.disabled = disabled;
            if (dataIndex !== null) input.dataset.index = dataIndex; 
            if (type !== null && type !== 'quotient') input.dataset.type = type; 
            return input;
        }
        
        function getColumnForLastDigitOf(numberStr, baseAlignIndexInDividend) {
            // Az osztandó 0-alapú indexe, ami alá a szám utolsó számjegye kerül.
            // Grid oszlopok: 1. az operátor, 2-től az osztandó számjegyei.
            return baseAlignIndexInDividend + 2; // +1 az op oszlop, +1 a 0-alapú index miatt
        }


        function highlightCurrentDividendPart() {
            mainDivisionGrid.querySelectorAll('.grid-cell.dividend-digit.current-dividend-part').forEach(el => el.classList.remove('current-dividend-part'));
            if (currentStepIndex >= task.steps.length) return;

            const step = task.steps[currentStepIndex];
            const dividendStr = String(task.dividend);
            
            let highlightStartIndex = 0;
            if (currentStepIndex > 0) {
                const prevStep = task.steps[currentStepIndex - 1];
                highlightStartIndex = prevStep.baseDigitIndexOfOriginalPartEnd + 1 - String(prevStep.subtractResult).length;
                if (prevStep.subtractResult === 0) highlightStartIndex = prevStep.baseDigitIndexOfOriginalPartEnd +1;
            }
            let highlightEndIndex = step.baseDigitIndexOfOriginalPartEnd;
            
            highlightStartIndex = Math.max(0, highlightStartIndex); 
            highlightEndIndex = Math.min(dividendStr.length - 1, highlightEndIndex); 

            for (let i = highlightStartIndex; i <= highlightEndIndex; i++) {
                const dividendCell = mainDivisionGrid.querySelector(`.grid-cell.dividend-digit[data-original-dividend-index="${i}"]`);
                if (dividendCell) {
                    dividendCell.classList.add('current-dividend-part');
                }
            }
        }


        function prepareCurrentStepInputs() {
            mainDivisionGrid.querySelectorAll('input.styled-input').forEach(inp => { 
                inp.style.borderColor = ''; 
                // Explicit letiltás, kivéve ha az aktuális lépéshez tartozik és engedélyezni kell
                if (!inp.classList.contains('quotient-digit-input') || (inp.classList.contains('quotient-digit-input') && inp.dataset.index != currentStepIndex)) {
                    inp.disabled = true;
                } else if (inp.classList.contains('quotient-digit-input') && inp.dataset.index == currentStepIndex && currentSubStep !== 'estimate') {
                    inp.disabled = true; // Ha már becsültünk, a hányadosjegy nem módosítható
                }
            });


            if (currentStepIndex >= task.steps.length) {
                checkStepButton.textContent = "Új feladat";
                finalRemainderValueEl.textContent = task.finalRemainder;
                mainDivisionGrid.querySelectorAll('.grid-cell.current-dividend-part').forEach(el => el.classList.remove('current-dividend-part'));
                return;
            }

            highlightCurrentDividendPart();
            const currentStepData = task.steps[currentStepIndex];
            const quotientDigitInput = mainDivisionGrid.querySelector(`.quotient-digit-input[data-index="${currentStepIndex}"]`);


            if (currentSubStep === 'estimate') {
                if (quotientDigitInput) {
                    quotientDigitInput.disabled = false; // Explicit engedélyezés
                    quotientDigitInput.value = (currentSettings.helpLevel === 'guided') ? currentStepData.quotientDigit : '';
                    if(currentSettings.helpLevel !== 'guided') quotientDigitInput.focus();
                }
            } else { 
                if (quotientDigitInput) {
                    if (!quotientDigitInput.value && currentSettings.helpLevel === 'guided') {
                        quotientDigitInput.value = currentStepData.quotientDigit;
                    }
                    quotientDigitInput.disabled = true;
                }
                
                const multiplyResultStr = String(currentStepData.multiplyResult);
                const subtractResultStr = String(currentStepData.subtractResult);
                const baseAlignGridColForLastDigit = getColumnForLastDigitOf(multiplyResultStr, currentStepData.baseDigitIndexOfOriginalPartEnd);


                if (currentSubStep === 'multiply') {
                    // Mínusz jel az első oszlopba
                    mainDivisionGrid.appendChild(createGridCell('-', mainGridCurrentRow, 1, ['op-symbol']));

                    // Szorzás eredményének számjegyei
                    const multiplyStartCol = baseAlignGridColForLastDigit - multiplyResultStr.length + 1;
                    for (let i = 0; i < multiplyResultStr.length; i++) {
                        const digitInput = createStyledInput((currentSettings.helpLevel === 'guided'), i, 'multiply');
                        if(currentSettings.helpLevel === 'guided') digitInput.value = multiplyResultStr[i];
                        
                        const cell = createGridCell(null, mainGridCurrentRow, multiplyStartCol + i);
                        cell.appendChild(digitInput);
                        mainDivisionGrid.appendChild(cell);
                        if (i === 0 && currentSettings.helpLevel !== 'guided') digitInput.focus();
                    }
                    mainGridCurrentRow++;
                } else if (currentSubStep === 'subtract') {
                    const lineStartCol = baseAlignGridColForLastDigit - multiplyResultStr.length + 1;
                    const lineCell = createGridCell(null, mainGridCurrentRow, lineStartCol); 
                    lineCell.style.gridColumn = `${lineStartCol} / span ${multiplyResultStr.length}`;
                    const hrLine = document.createElement('hr');
                    hrLine.classList.add('division-line-hr-grid');
                    lineCell.appendChild(hrLine); 
                    mainDivisionGrid.appendChild(lineCell);
                    mainGridCurrentRow++;

                    const subtractStartCol = getColumnForLastDigitOf(subtractResultStr, currentStepData.baseDigitIndexOfOriginalPartEnd) - subtractResultStr.length + 1;
                    for (let i = 0; i < subtractResultStr.length; i++) {
                        const digitInput = createStyledInput((currentSettings.helpLevel === 'guided'), i, 'subtract');
                        if(currentSettings.helpLevel === 'guided') digitInput.value = subtractResultStr[i];

                        const cell = createGridCell(null, mainGridCurrentRow, subtractStartCol + i);
                        cell.appendChild(digitInput);
                        mainDivisionGrid.appendChild(cell);
                        if (i === 0 && currentSettings.helpLevel !== 'guided') digitInput.focus();
                    }

                    if (currentStepData.nextDigitToBringDown !== null) {
                        const cell = createGridCell(currentStepData.nextDigitToBringDown, mainGridCurrentRow, subtractStartCol + subtractResultStr.length, ['brought-down-digit']);
                        mainDivisionGrid.appendChild(cell);
                    }
                }
            }
            updateTaskInstructions();
        }
        
        function handleCheck() {
            if (currentStepIndex >= task.steps.length) {
                generateNewTask();
                checkStepButton.textContent = currentSettings.helpLevel === 'independent' ? 'Teljes ellenőrzés' : 'Lépés ellenőrzése';
                return;
            }

            const currentStepData = task.steps[currentStepIndex];
            let isCorrect = false;
            let userInputStr = "";
            let activeInputs = [];

            if (currentSubStep === 'estimate') {
                const quotientDigitInput = mainDivisionGrid.querySelector(`.quotient-digit-input[data-index="${currentStepIndex}"]`);
                activeInputs.push(quotientDigitInput);
                userInputStr = quotientDigitInput.value;
                if (userInputStr.trim() === "" || isNaN(parseInt(userInputStr))) {
                    feedbackArea.textContent = "Kérlek, írj be egy számot a hányadosba!";
                    feedbackArea.className = 'feedback incorrect mt-4';
                    activeInputs.forEach(inp => updateInputFieldFeedback(inp, false));
                    return;
                }
                isCorrect = parseInt(userInputStr) === currentStepData.quotientDigit;
                if (isCorrect) currentSubStep = 'multiply';
                
            } else { 
                activeInputs = Array.from(mainDivisionGrid.querySelectorAll(`.styled-input[data-type="${currentSubStep}"]:not([disabled])`));
                if (activeInputs.length === 0 && currentSettings.helpLevel !== 'guided') { 
                    prepareCurrentStepInputs(); 
                    return;
                }
                activeInputs.forEach(input => userInputStr += input.value);

                if (userInputStr.trim() === "" || (userInputStr.length !== activeInputs.length && activeInputs.length > 0) || isNaN(parseInt(userInputStr))) {
                    feedbackArea.textContent = `Kérlek, írj be minden számjegyet a ${currentSubStep === 'multiply' ? 'szorzathoz' : 'különbséghez'}!`;
                    feedbackArea.className = 'feedback incorrect mt-4';
                    activeInputs.forEach(inp => updateInputFieldFeedback(inp, false));
                    return;
                }

                if (currentSubStep === 'multiply') {
                    isCorrect = parseInt(userInputStr) === currentStepData.multiplyResult;
                    if (isCorrect) currentSubStep = 'subtract';
                } else { 
                    isCorrect = parseInt(userInputStr) === currentStepData.subtractResult;
                }
            }
            
            activeInputs.forEach(inp => updateInputFieldFeedback(inp, isCorrect));

            if (isCorrect) {
                feedbackArea.textContent = "Helyes! Haladj tovább.";
                feedbackArea.className = 'feedback correct mt-4';
                activeInputs.forEach(inp => inp.disabled = true); 

                if (currentSettings.helpLevel === 'guided') {
                    if (currentSubStep === 'multiply') { 
                        prepareCurrentStepInputs(); 
                        currentSubStep = 'subtract';
                        prepareCurrentStepInputs(); 
                        handleStepCompletion();
                    } else if (currentSubStep === 'subtract'){ 
                         prepareCurrentStepInputs(); 
                         handleStepCompletion();
                    } else { 
                        handleStepCompletion();
                    }
                } else { 
                    if (currentSubStep === 'multiply' || currentSubStep === 'subtract') {
                        prepareCurrentStepInputs();
                    }
                }
                 if (currentSubStep === 'subtract' && isCorrect && currentSettings.helpLevel !== 'guided' && parseInt(userInputStr) === currentStepData.subtractResult) {
                    handleStepCompletion();
                }
            } else {
                feedbackArea.textContent = "Nem pontos. Próbáld újra!";
                feedbackArea.className = 'feedback incorrect mt-4';
            }
        }
        
        function updateInputFieldFeedback(inputElement, isCorrect) {
            if (!inputElement) return;
            inputElement.style.borderColor = isCorrect ? 'green' : 'red';
        }

        function handleStepCompletion() {
            mainGridCurrentRow++; 
            currentStepIndex++;
            currentSubStep = 'estimate';
            if (currentStepIndex < task.steps.length) {
                prepareCurrentStepInputs();
            } else {
                taskInstructions.textContent = "Kész vagy! Ez volt az utolsó lépés.";
                checkStepButton.textContent = "Új feladat";
                finalRemainderValueEl.textContent = task.finalRemainder;
                feedbackArea.textContent = "Gratulálok, sikeresen elvégezted az osztást!";
                feedbackArea.className = 'feedback correct mt-4';
                highlightCurrentDividendPart();
            }
            updateTaskInstructions();
        }
        
        function updateTaskInstructions() {
            if (currentStepIndex >= task.steps.length) {
                 taskInstructions.textContent = `Az osztás véget ért. A végső maradék: ${task.finalRemainder}.`;
                 return;
            }
            const stepData = task.steps[currentStepIndex];
            switch(currentSubStep) {
                case 'estimate':
                    taskInstructions.textContent = `Hányszor van meg a(z) ${stepData.currentDividendPartNumForStep}-ben a(z) ${task.divisor}? (Hányados ${currentStepIndex+1}. számjegye)`;
                    break;
                case 'multiply':
                    const qInput = mainDivisionGrid.querySelector(`.quotient-digit-input[data-index="${currentStepIndex}"]`);
                    const qDigit = qInput ? (qInput.value || (currentSettings.helpLevel === 'guided' ? stepData.quotientDigit : '?')) : '?';
                    taskInstructions.textContent = `Mennyi ${qDigit} × ${task.divisor}? (Szorzat)`;
                    break;
                case 'subtract':
                     let multiplyValueStr = "";
                     // A szorzás eredményének számjegyeit az előző sorból (mainGridCurrentRow - 1) kellene keresni
                     // Vagy egyszerűbben: az utoljára letiltott 'multiply-digit-value' inputokból
                     const multiplyInputs = Array.from(mainDivisionGrid.querySelectorAll('.multiply-digit-value[disabled]'))
                                            .filter(inp => inp.parentElement.style.gridRow == (mainGridCurrentRow -1) );
                     
                     if(multiplyInputs.length === 0 && currentSettings.helpLevel === 'guided') multiplyValueStr = String(stepData.multiplyResult);
                     else multiplyInputs.forEach(inp => multiplyValueStr += inp.value);

                     const multVal = multiplyValueStr || '?';
                    taskInstructions.textContent = `Mennyi ${stepData.currentDividendPartNumForStep} - ${multVal}? (Különbség)`;
                    break;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            applyTheme(); 
            updateActiveButtonVisuals(dividendLengthSelector, dividendLengthSelector.querySelector(`[data-length="${currentSettings.dividendLength}"]`));
            updateActiveButtonVisuals(remainderTypeSelector, remainderTypeSelector.querySelector(`[data-remainder="${currentSettings.remainderType}"]`));
            updateActiveButtonVisuals(helpLevelSelector, helpLevelSelector.querySelector(`[data-help="${currentSettings.helpLevel}"]`));
            checkStepButton.textContent = currentSettings.helpLevel === 'independent' ? 'Teljes ellenőrzés' : 'Lépés ellenőrzése';
            generateNewTask();
        });

    </script>
</body>
</html>
